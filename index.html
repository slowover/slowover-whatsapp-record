<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>SlowOver CRM V66.0</title>
    <style>
        :root { 
            --primary: #D4A373; --bg: #FAF7F2; --text: #5F4B32; 
            --accent: #8EAD91; --blue: #5C7CFA; --red: #E03131; 
            --green: #40C057; --gray: #999; --yellow: #FFD43B;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { -webkit-user-select: none; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        input, textarea { -webkit-user-select: text !important; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 20px 15px calc(var(--safe-bottom) + 100px) 15px; }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(15px); display: flex; padding-bottom: var(--safe-bottom); border-top: 1px solid #EEE; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px 0; text-align: center; font-size: 11px; color: var(--gray); font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        .card { background: white; padding: 18px; border-radius: 22px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        
        input, select, button { width: 100%; padding: 12px; margin: 5px 0; border: 1px solid #E0D7CC; border-radius: 12px; font-size: 14px; outline: none; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        .order-card { background: white; padding: 18px; border-radius: 25px; margin-bottom: 15px; border-left: 8px solid var(--primary); position: relative; }
        .item-box { background: #FCFAf7; padding: 10px; border-radius: 12px; margin: 5px 0; border: 1px solid #F0E6D8; position: relative; }
        
        .status-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; margin: 10px 0; }
        .st-btn { font-size: 10px; padding: 8px 0; border-radius: 10px; background: #F8F9FA; color: #BBB; border: 1px solid #EEE; text-align: center; }
        .st-btn.active.paid { background: var(--green); color: white; border-color: var(--green); }
        .st-btn.active.shipped { background: var(--blue); color: white; border-color: var(--blue); }
        
        .tag { font-size: 9px; padding: 3px 7px; border-radius: 6px; font-weight: bold; margin-right: 5px; display: inline-block; cursor: pointer; border: 1px solid transparent; }
        .tag-bought { background: #FFF9DB; color: #E67E22; border-color: #FFEC99; }
        .tag-bought.active { background: var(--yellow); color: #856404; }
        .tag-arrived { background: #E7F5FF; color: var(--blue); border-color: #A5D8FF; }
        .tag-arrived.active { background: var(--blue); color: white; }

        .search-box { position: sticky; top: 0; background: var(--bg); z-index: 100; padding: 10px 0; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('main', this)">ğŸ“ è¨‚å–®</div>
        <div class="nav-item" onclick="switchPage('buy', this)">ğŸ›ï¸ æ¡è³¼</div>
        <div class="nav-item" onclick="switchPage('stats', this)">ğŸ“Š çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchPage('tools', this)">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="page-main" class="page active">
        <h2 style="padding-left:10px;">æ–°è¨‚å–®</h2>
        <div class="card">
            <input type="date" id="order-date">
            <input type="tel" id="cust-tel" placeholder="å®¢æˆ¶é›»è©± (WhatsApp)">
            <div id="items-area"></div>
            <button onclick="addItemRow()" style="background:#F1F3F5; color:var(--text); margin-top:10px;">+ æ–°å¢å•†å“</button>
            <button onclick="saveOrder()" style="height:60px; margin-top:15px; font-size:18px; background:var(--accent); font-weight:bold;">ğŸ’¾ å„²å­˜è¨‚å–®</button>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="page-buy" class="page">
        <h2 style="padding-left:10px;">ğŸ›ï¸ æ¡è³¼æ¸…å–® (æœªè²·é …ç›®)</h2>
        <div id="buy-container"></div>
    </div>

    <div id="page-stats" class="page">
        <div class="search-box">
            <input type="text" id="main-search" placeholder="ğŸ” æœå°‹é›»è©±ã€å•†å“æˆ–å–®è™Ÿ..." oninput="renderStats()">
        </div>
        <div id="stats-summary" style="display:flex; gap:10px; margin-bottom:15px;"></div>
        <div id="stats-list"></div>
    </div>

    <div id="page-tools" class="page">
        <h2 style="padding-left:10px;">âš™ï¸ åŒ¯ç‡èˆ‡ç³»çµ±</h2>
        <div class="card">
            <h3>ğŸ’° åŒ¯ç‡åŠ©æ‰‹</h3>
            <select id="cur-sel" onchange="calcEx()"><option value="KRW">éŸ“å¹£</option><option value="JPY">æ—¥å¹£</option><option value="THB">æ³°å¹£</option></select>
            <input type="number" id="ex-in" placeholder="è¼¸å…¥å¤–å¹£é‡‘é¡" oninput="calcEx()">
            <div style="display:flex; gap:5px;"><button class="fee-btn active" onclick="setFee(1.03, this)">+3% æ‰¹ç™¼</button><button class="fee-btn" onclick="setFee(1.05, this)">+5% é›¶å”®</button></div>
            <div id="ex-res" style="font-size:24px; text-align:center; color:var(--primary); font-weight:bold; margin:10px 0;"></div>
        </div>
        <div class="card">
            <button onclick="syncToCloud()" style="background:var(--blue)">åŒæ­¥è‡³é›²ç«¯</button>
            <button onclick="syncFromCloud()" style="background:var(--accent); margin-top:10px;">å¾é›²ç«¯ä¸‹è¼‰</button>
            <button onclick="clearAllData()" style="background:var(--red); margin-top:20px;">âš ï¸ æ¸…é™¤æ‰€æœ‰æ•¸æ“š</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyCRh9BCDLiMkj3099u2ZPOtbTUA17uryJ80iKjIdICkUZuA94lOuptNJgzJpVWjaGzUA/exec";
        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        let orders = JSON.parse(localStorage.getItem('slow_v62_data') || '[]');
        let serial = parseInt(localStorage.getItem('slow_v62_serial') || '300');
        let currentFee = 1.03;
        let rates = { KRW: 0.00585, JPY: 0.0525, THB: 0.222 };

        function addItemRow() {
            const div = document.createElement('div');
            div.className = 'item-box';
            div.innerHTML = `<input type="text" placeholder="å•†å“åç¨±" class="in-n"><div style="display:flex; gap:5px;"><input type="number" value="1" class="in-q" style="flex:1"><input type="number" placeholder="å”®åƒ¹" class="in-p" style="flex:2"></div><button onclick="this.parentElement.remove()" style="position:absolute; top:5px; right:10px; width:auto; background:none; color:var(--red); font-size:12px;">âœ•</button>`;
            document.getElementById('items-area').appendChild(div);
        }

        function saveOrder() {
            const elTel = document.getElementById('cust-tel');
            const elDate = document.getElementById('order-date');
            const rows = document.querySelectorAll('.item-box');
            if(!elTel.value) return alert("è«‹è¼¸å…¥é›»è©±");
            
            let items = [], total = 0;
            rows.forEach(r => {
                const n = r.querySelector('.in-n').value;
                const q = parseInt(r.querySelector('.in-q').value) || 1;
                const p = parseFloat(r.querySelector('.in-p').value) || 0;
                if(n) { items.push({name:n, qty:q, price:p, bought:false, arrived:false}); total += (q*p); }
            });

            const id = `WS${new Date().getFullYear().toString().slice(-2)}${MONTHS[new Date().getMonth()]}${serial++}`;
            orders.push({ id, date: elDate.value, tel: elTel.value, items, totalPrice: total, paid:false, shipped:false, address: "", sfNo: "" });
            save();
            elTel.value = ""; document.getElementById('items-area').innerHTML = ""; addItemRow();
            alert("âœ… å„²å­˜æˆåŠŸ: " + id);
            render();
        }

        function render() {
            const list = document.getElementById('list-container');
            if(!list) return;
            let html = "";
            orders.slice().reverse().forEach(o => {
                const ri = orders.indexOf(o);
                html += `<div class="order-card">
                    <div style="display:flex; justify-content:space-between;"><small>#${o.id}</small><b>$${o.totalPrice}</b></div>
                    <strong>ğŸ“ ${o.tel}</strong>
                    ${o.items.map((it, ii) => `
                        <div class="item-box">
                            <div>${it.name} x${it.qty}</div>
                            <div class="tag tag-bought ${it.bought?'active':''}" onclick="toggleItemTag(${ri},${ii},'bought')">å·²è²·</div>
                            <div class="tag tag-arrived ${it.arrived?'active':''}" onclick="toggleItemTag(${ri},${ii},'arrived')">å·²åˆ°æ¸¯</div>
                        </div>
                    `).join('')}
                    <div class="status-grid">
                        <div class="st-btn paid ${o.paid?'active':''}" onclick="updStatus(${ri},'paid')">å·²ä»˜</div>
                        <div class="st-btn shipped ${o.shipped?'active':''}" onclick="updStatus(${ri},'shipped')">å·²å¯„</div>
                    </div>
                    <input type="text" placeholder="ğŸ“ ç™»è¨˜æ”¶è²¨è³‡æ–™" value="${o.address||''}" onchange="updInfo(${ri},'address',this.value)">
                    <input type="text" placeholder="ğŸšš ç™»è¨˜é‹å–®è™Ÿç¢¼" value="${o.sfNo||''}" onchange="updInfo(${ri},'sfNo',this.value)">
                    <button onclick="copyAskInfo(${ri})" style="background:var(--accent); font-size:11px; margin-top:5px;">ğŸ“‹ ç´¢å–æ”¶è²¨è³‡æ–™</button>
                    <button onclick="delOrder(${ri})" style="background:none; color:var(--red); font-size:10px;">åˆªé™¤</button>
                </div>`;
            });
            list.innerHTML = html;
        }

        // --- çµ±è¨ˆèˆ‡æœå°‹åŠŸèƒ½ ---
        function renderStats() {
            const key = document.getElementById('main-search').value.toLowerCase();
            const container = document.getElementById('stats-list');
            let html = "";
            let filterOrders = orders.filter(o => 
                o.tel.includes(key) || o.id.toLowerCase().includes(key) || 
                o.items.some(it => it.name.toLowerCase().includes(key))
            );

            filterOrders.slice().reverse().forEach(o => {
                html += `<div class="card" style="font-size:12px;">
                    <b>#${o.id}</b> | ${o.tel} | $${o.totalPrice} | ${o.paid?'âœ…å·²ä»˜':'âŒæœªä»˜'}<br>
                    ${o.items.map(it => it.name).join(', ')}
                </div>`;
            });
            container.innerHTML = html;
            
            // ç°¡æ˜“çµ±è¨ˆ
            const totalEarn = filterOrders.reduce((sum, o) => sum + o.totalPrice, 0);
            document.getElementById('stats-summary').innerHTML = `<div class="card" style="flex:1; text-align:center;">ç¬¦åˆç­†æ•¸<br><b>${filterOrders.length}</b></div><div class="card" style="flex:1; text-align:center;">ç¸½é‡‘é¡<br><b>$${totalEarn}</b></div>`;
        }

        // --- æ¥­å‹™é‚è¼¯ ---
        function toggleItemTag(ri, ii, key) { orders[ri].items[ii][key] = !orders[ri].items[ii][key]; save(); }
        function updStatus(ri, key) { orders[ri][key] = !orders[ri][key]; save(); }
        function updInfo(ri, key, val) { orders[ri][key] = val; save(); }
        function copyAskInfo(ri) {
            const msg = `ã€SlowOver ç´¢å–æ”¶è²¨è³‡æ–™ã€‘\nå–®è™Ÿï¼š#${orders[ri].id}\nè¨‚å–®å·²æº–å‚™å¥½ï¼Œè«‹æä¾›ï¼š\n1. æ”¶ä»¶äººå§“åï¼š\n2. è¯çµ¡é›»è©±ï¼š\n3. é †è±ç«™/æ™ºèƒ½æ«ƒç·¨è™Ÿ æˆ– åœ°å€ï¼š\n\næ„Ÿè¬æ”¯æŒï¼ğŸŒ»`;
            navigator.clipboard.writeText(msg); alert("âœ… è¨Šæ¯å·²è¤‡è£½");
        }
        function save() { 
            localStorage.setItem('slow_v62_data', JSON.stringify(orders)); 
            localStorage.setItem('slow_v62_serial', serial); 
            render(); if(document.getElementById('page-stats').classList.contains('active')) renderStats();
            if(document.getElementById('page-buy').classList.contains('active')) renderBuy();
        }

        // --- é é¢åˆ‡æ› ---
        function switchPage(p, btn) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            btn.classList.add('active');
            if(p === 'stats') renderStats();
            if(p === 'buy') renderBuy();
        }

        function renderBuy() {
            let html = "";
            orders.forEach((o, ri) => {
                o.items.forEach((it, ii) => {
                    if(!it.bought) {
                        html += `<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                            <div><b>#${o.id}</b><br>${it.name} x${it.qty}</div>
                            <button onclick="toggleItemTag(${ri},${ii},'bought')" style="width:80px; background:var(--yellow); color:#856404; font-size:12px;">å·²è²·</button>
                        </div>`;
                    }
                });
            });
            document.getElementById('buy-container').innerHTML = html || "<p style='text-align:center;'>ğŸ‰ æ‰€æœ‰å•†å“å·²æ¡è³¼</p>";
        }

        // åŒ¯ç‡åŠ©æ‰‹èˆ‡åŒæ­¥åŠŸèƒ½ï¼ˆçœç•¥ä»¥ç¯€çœç©ºé–“ï¼Œèˆ‡å‰ç‰ˆæœ¬ä¸€è‡´ï¼‰
        function calcEx() {
            const amt = document.getElementById('ex-in').value;
            const cur = document.getElementById('cur-sel').value;
            const res = (amt * rates[cur] * currentFee).toFixed(2);
            document.getElementById('ex-res').innerText = amt ? `HKD $${res}` : "";
        }
        function setFee(f, btn) { currentFee = f; document.querySelectorAll('.fee-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); calcEx(); }
        async function syncToCloud() { try { const blob = new Blob([JSON.stringify(orders)], {type: 'text/plain'}); await fetch(GAS_URL, { method: 'POST', body: blob, mode: 'no-cors' }); alert("âœ… ä¸Šå‚³ç™¼é€"); } catch(e) { alert("å¤±æ•—"); } }
        async function syncFromCloud() { try { const res = await fetch(GAS_URL); orders = await res.json(); save(); alert("âœ… ä¸‹è¼‰å®Œæˆ"); } catch(e) { alert("ä¸‹è¼‰å¤±æ•—"); } }
        function clearAllData() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
        function delOrder(i) { if(confirm("ç¢ºå®šï¼Ÿ")) { orders.splice(i,1); save(); } }

        window.onload = () => { document.getElementById('order-date').valueAsDate = new Date(); addItemRow(); render(); };
    </script>
</body>
</html>
