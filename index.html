<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SlowOver CRM V70.0</title>
    <style>
        :root { 
            --primary: #D4A373; --bg: #FAF7F2; --text: #5F4B32; 
            --accent: #8EAD91; --blue: #5C7CFA; --red: #E03131; 
            --green: #40C057; --purple: #7048E8; --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px calc(var(--safe-bottom) + 100px) 15px; }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; padding-bottom: var(--safe-bottom); border-top: 1px solid #EEE; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px 0; text-align: center; font-size: 11px; color: #999; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        input, select, button { width: 100%; padding: 12px; margin: 4px 0; border: 1px solid #E0D7CC; border-radius: 10px; font-size: 14px; outline: none; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .order-card { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #EEE; border-left: 8px solid var(--primary); }
        .item-box { background: #FCFAf7; padding: 10px; border-radius: 12px; margin: 8px 0; border: 1px solid #F0E6D8; position: relative; }
        .status-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; margin: 10px 0; }
        .st-btn { font-size: 9px; padding: 10px 0; border-radius: 8px; background: #F8F9FA; color: #BBB; border: 1px solid #EEE; text-align: center; font-weight: bold; }
        .st-btn.active.paid { background: var(--green); color: white; }
        .st-btn.active.arrivedAll { background: var(--purple); color: white; }
        .st-btn.active.shipped { background: var(--blue); color: white; }
        .st-btn.active.refunded { background: var(--red); color: white; }
        .tag { font-size: 10px; padding: 5px 10px; border-radius: 6px; display: inline-block; cursor: pointer; margin-right: 5px; margin-top: 5px; font-weight: bold; border: 1px solid #DDD; background: #FFF; color: #999; }
        .tag.active.buy { background: #FFD43B; color: #856404; border-color: #FFD43B; }
        .tag.active.arr { background: var(--blue); color: white; border-color: var(--blue); }
        .quote-hist { font-size: 11px; border-bottom: 1px solid #EEE; padding: 8px 0; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('main', this)">ğŸ“ è¨‚å–®</div>
        <div class="nav-item" onclick="switchPage('buy', this)">ğŸ›ï¸ æ¡è³¼</div>
        <div class="nav-item" onclick="switchPage('stats', this)">ğŸ“Š çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchPage('tools', this)">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="page-main" class="page active">
        <div class="card">
            <input type="date" id="order-date">
            <input type="tel" id="cust-tel" placeholder="å®¢æˆ¶é›»è©± (WhatsApp)">
            <div id="items-area"></div>
            <button onclick="addItemRow()" style="background:#F1F3F5; color:var(--text);">+ æ–°å¢å•†å“</button>
            <button onclick="saveOrder()" style="height:55px; margin-top:15px; background:var(--accent);">ğŸ’¾ å„²å­˜è¨‚å–®</button>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="page-buy" class="page">
        <h2 style="padding-left:10px;">ğŸ›ï¸ æ¡è³¼æ¸…å–®é€²åº¦</h2>
        <div class="card" id="buy-content"></div>
    </div>

    <div id="page-stats" class="page">
        <div class="card">
            <input type="text" id="main-search" placeholder="ğŸ” æœå°‹é›»è©±/å•†å“/å–®è™Ÿ" oninput="renderStats()">
            <div style="display:flex; gap:5px; margin-top:8px;">
                <input type="date" id="stat-sdate" onchange="renderStats()">
                <input type="date" id="stat-edate" onchange="renderStats()">
            </div>
        </div>
        <div id="stats-summary-box" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"></div>
        <div id="stats-list"></div>
    </div>

    <div id="page-tools" class="page">
        <div class="card">
            <h3>ğŸ’° åŒ¯ç‡åŠ©æ‰‹ (å ±åƒ¹æ­·å²)</h3>
            <select id="cur-sel" onchange="calcEx()">
                <option value="KRW">éŸ“å¹£ (0.00585)</option>
                <option value="JPY">æ—¥å¹£ (0.0525)</option>
                <option value="THB">æ³°å¹£ (0.222)</option>
            </select>
            <input type="number" id="ex-in" placeholder="å¤–å¹£é‡‘é¡" oninput="calcEx()">
            <div style="display:flex; gap:5px;">
                <button class="fee-btn" onclick="setFee(1.03, this)" style="background:var(--accent)">+3% æ‰¹ç™¼</button>
                <button class="fee-btn" onclick="setFee(1.05, this)" style="background:#EEE; color:#666;">+5% é›¶å”®</button>
            </div>
            <div id="ex-res" style="font-size:28px; text-align:center; color:var(--primary); font-weight:bold;"></div>
            <div id="quote-history-list" style="margin-top:15px; max-height:200px; overflow-y:auto;"></div>
        </div>
        <div class="card">
            <button onclick="syncToCloud()" style="background:var(--blue)">â˜ï¸ ä¸Šå‚³è‡³é›²ç«¯ (å«å•†å“è©³æƒ…)</button>
            <button onclick="syncFromCloud()" style="background:var(--accent); margin-top:10px;">â˜ï¸ å¾é›²ç«¯ä¸‹è¼‰</button>
            <button onclick="resetSerial()" style="margin-top:20px;">ğŸ”¢ è‡ªè¨‚å–®è™Ÿèµ·å§‹</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxPku0qTD-XQvctzBYfHQNflwBn0QH-WjwTzPwfWMDsyMvym94i0f-MlXtUbHpEjJZaRA/exec";
        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        let orders = JSON.parse(localStorage.getItem('slow_v62_data') || '[]');
        let quotes = JSON.parse(localStorage.getItem('slow_quotes') || '[]');
        let serial = parseInt(localStorage.getItem('slow_v62_serial') || '300');
        let currentFee = 1.03;
        let rates = { KRW: 0.00585, JPY: 0.0525, THB: 0.222 };

        const PAY_INFO = `PayMeï¼šhttps://qr.payme.hsbc.com.hk/2/Ui316pJ5T8b428yzTSbr4J\n\nFPS:\nå¿«é€Ÿæ”¯ä»˜ç³»çµ±è­˜åˆ¥ç¢¼FPS IDï¼š105249023\nåç¨±ï¼šslow over\n\næ³¨æ„äº‹é …ï¼š\n24å°æ™‚å…§å®Œæˆä»˜æ¬¾ä¸¦å›å‚³å…¥æ•¸æˆªåœ–\næˆªåœ–è«‹å‚™è¨»é›»è©±è™Ÿç¢¼ä»¥ä¾¿å°è³¬`;
        const TERMS = `ä¸‹å–®å³åŒæ„ä»¥ä¸‹æ¢æ¬¾ï¼š\n1. 24å°æ™‚å…§å®Œæˆä»˜æ¬¾ä¸¦å›å‚³å…¥æ•¸æˆªåœ–ã€‚\n2. æˆªåœ–è«‹å‚™è¨»æˆ–è¨Šæ¯é›»è©±è™Ÿç¢¼ä»¥ä¾¿å°è³¬ã€‚\n3. è¨‚å–®ä¸€ç¶“ç¢ºèªï¼Œä¸è¨­å–æ¶ˆã€é€€æ›æˆ–æ›´æ”¹ã€‚\n4. å¦‚é‡å•†å“ç¼ºè²¨ï¼Œå°‡æœƒå…¨æ•¸é€€æ¬¾ã€‚\n5. ä¸€èˆ¬é è¨‚éœ€æ™‚ 7-30 å€‹å·¥ä½œå¤©ï¼Œä¸æ¥æ€¥å–®ã€‚\n6. é‹é€éç¨‹å¦‚æœ‰æå£é¢¨éšªéœ€ç”±è²·å®¶æ‰¿æ“”ã€‚\n7. SLOWOVER ä¿ç•™æœ€çµ‚æ±ºå®šæ¬Šã€‚\næ„Ÿè¬æ”¯æŒ SLOWOVERï¼ğŸŒ»`;

        function addItemRow() {
            const div = document.createElement('div');
            div.className = 'item-box';
            div.innerHTML = `<input type="text" placeholder="å•†å“åç¨±" class="in-n"><div style="display:flex; gap:5px;"><input type="number" value="1" class="in-q" style="flex:1"><input type="number" placeholder="å”®åƒ¹" class="in-p" style="flex:2"><input type="number" placeholder="æˆæœ¬" class="in-c" style="flex:2"></div><button onclick="this.parentElement.remove()" style="position:absolute; top:5px; right:10px; background:none; color:var(--red); border:none; font-size:11px;">âœ•</button>`;
            document.getElementById('items-area').appendChild(div);
        }

        function saveOrder() {
            const tel = document.getElementById('cust-tel').value.trim();
            const date = document.getElementById('order-date').value;
            const rows = document.querySelectorAll('.item-box');
            if(!tel || rows.length === 0) return alert("è«‹å¡«å¯«è³‡æ–™");
            let items = [], tp = 0, tc = 0;
            rows.forEach(r => {
                const n = r.querySelector('.in-n').value, q = parseInt(r.querySelector('.in-q').value) || 1, p = parseFloat(r.querySelector('.in-p').value) || 0, c = parseFloat(r.querySelector('.in-c').value) || 0;
                if(n) { items.push({name:n, qty:q, price:p, cost:c, bought:false, arrived:false}); tp += (q*p); tc += (q*c); }
            });
            const id = `WS${new Date().getFullYear().toString().slice(-2)}${MONTHS[new Date().getMonth()]}${serial++}`;
            orders.push({ id, date, tel, items, totalPrice: tp, totalCost: tc, paid:false, arrivedAll:false, shipped:false, refunded:false, address:"", sfNo:"" });
            save(); render(); alert("âœ… å„²å­˜æˆåŠŸ: " + id);
            document.getElementById('cust-tel').value = ""; document.getElementById('items-area').innerHTML = ""; addItemRow();
        }

        function render() {
            const list = document.getElementById('list-container');
            if(!list) return;
            let html = "";
            orders.slice().reverse().forEach(o => {
                const ri = orders.indexOf(o);
                html += `<div class="order-card">
                    <div style="display:flex; justify-content:space-between;"><small>#${o.id}</small><b style="color:var(--red)">$${o.totalPrice}</b></div>
                    <strong>ğŸ“ ${o.tel}</strong>
                    ${o.items.map((it, ii) => `
                        <div class="item-box">
                            <div style="display:flex; justify-content:space-between;"><span>${it.name} x${it.qty}</span><span onclick="delItem(${ri},${ii})" style="color:var(--red); font-size:10px;">âœ–</span></div>
                            <div class="tag buy ${it.bought?'active':''}" onclick="toggleTag(${ri},${ii},'bought')">${it.bought?'å·²è²·':'æœªè²·'}</div>
                            <div class="tag arr ${it.arrived?'active':''}" onclick="toggleTag(${ri},${ii},'arrived')">${it.arrived?'å·²åˆ°æ¸¯':'æœªåˆ°'}</div>
                        </div>`).join('')}
                    <div class="status-grid">
                        <div class="st-btn paid ${o.paid?'active':''}" onclick="updStatus(${ri},'paid')">å·²ä»˜æ¬¾</div>
                        <div class="st-btn arrivedAll ${o.arrivedAll?'active':''}" onclick="updStatus(${ri},'arrivedAll')">å…¨åˆ°æ¸¯</div>
                        <div class="st-btn shipped ${o.shipped?'active':''}" onclick="updStatus(${ri},'shipped')">å·²å¯„å‡º</div>
                        <div class="st-btn refunded ${o.refunded?'active':''}" onclick="updStatus(${ri},'refunded')">å·²é€€æ¬¾</div>
                    </div>
                    <input type="text" placeholder="æ”¶ä»¶è³‡æ–™ (å§“å/é›»è©±/åœ°é»)" value="${o.address||''}" onchange="updInfo(${ri},'address',this.value)" style="background:#F8F9FA">
                    <input type="text" placeholder="ğŸšš é‹å–®è™Ÿç¢¼" value="${o.sfNo||''}" onchange="updInfo(${ri},'sfNo',this.value)" style="background:#F8F9FA">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                        <button onclick="copyNotice(${ri})" style="background:var(--accent); font-size:11px;">ğŸ“‹ è¤‡è£½å‡ºå–®é€šçŸ¥</button>
                        <button onclick="copyAskInfo(${ri})" style="background:var(--purple); font-size:11px;">ğŸ“‹ ç´¢å–æ”¶è²¨è³‡æ–™</button>
                    </div>
                    <button onclick="delOrder(${ri})" style="background:none; color:var(--red); font-size:10px; border:1px solid; margin-top:8px;">ğŸ—‘ï¸ å…¨å–®åˆªé™¤</button>
                </div>`;
            });
            list.innerHTML = html;
        }

        function toggleTag(ri, ii, key) {
            orders[ri].items[ii][key] = !orders[ri].items[ii][key];
            if(key === 'arrived') orders[ri].arrivedAll = orders[ri].items.every(i => i.arrived);
            save(); render();
        }

        function renderBuy() {
            let sum = {};
            orders.forEach(o => o.items.forEach(it => {
                if(!sum[it.name]) sum[it.name] = { total: 0, bought: 0 };
                sum[it.name].total += it.qty; if(it.bought) sum[it.name].bought += it.qty;
            }));
            let unDone = "", done = "";
            for(let n in sum) {
                const s = sum[n], row = `<div style="border-bottom:1px solid #EEE; padding:10px 0;"><b>${n}</b><br><small>ç¸½éœ€: ${s.total} | å·²è²·: ${s.bought} | <span style="color:var(--red)">æœªè²·: ${s.total-s.bought}</span></small></div>`;
                if(s.bought < s.total) unDone += row; else done += row;
            }
            document.getElementById('buy-content').innerHTML = `<h4>æœªå®Œæˆ</h4>${unDone || 'ğŸ‰ å…¨éƒ¨å·²è²·'}<hr><h4>å·²å®Œæˆ</h4>${done || 'ç„¡'}`;
        }

        function renderStats() {
            const key = document.getElementById('main-search').value.toLowerCase();
            const sd = document.getElementById('stat-sdate').value, ed = document.getElementById('stat-edate').value;
            let filtered = orders.filter(o => (o.tel.includes(key) || o.id.toLowerCase().includes(key) || o.items.some(i => i.name.toLowerCase().includes(key))) && (!sd || o.date >= sd) && (!ed || o.date <= ed));
            let rev = 0, cost = 0;
            filtered.forEach(o => { if(!o.refunded) { rev += o.totalPrice; cost += o.totalCost; } });
            document.getElementById('stats-summary-box').innerHTML = `<div style="background:var(--primary); color:white; padding:15px; border-radius:15px; text-align:center;">ç‡Ÿæ¥­é¡<br><b>$${rev.toFixed(1)}</b></div><div style="background:var(--accent); color:white; padding:15px; border-radius:15px; text-align:center;">åˆ©æ½¤<br><b>$${(rev-cost).toFixed(1)}</b></div>`;
            document.getElementById('stats-list').innerHTML = filtered.map(o => `<div class="card" style="font-size:12px;"><b>#${o.id}</b> | ${o.tel} <b style="float:right">$${o.totalPrice}</b></div>`).join('');
        }

        function calcEx() {
            const amt = document.getElementById('ex-in').value, cur = document.getElementById('cur-sel').value;
            if(!amt) return;
            const res = (amt * rates[cur] * currentFee).toFixed(2);
            document.getElementById('ex-res').innerText = `HKD $${res}`;
            quotes.unshift({ cur, amt, fee: (currentFee === 1.03 ? '+3%' : '+5%'), res, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
            if(quotes.length > 30) quotes.pop();
            localStorage.setItem('slow_quotes', JSON.stringify(quotes)); renderQuotes();
        }

        function renderQuotes() { document.getElementById('quote-history-list').innerHTML = quotes.map(q => `<div class="quote-hist"><span>${q.time} | ${q.amt}${q.cur} (${q.fee})</span><b>$${q.res}</b></div>`).join(''); }
        function setFee(f, btn) { currentFee = f; document.querySelectorAll('.fee-btn').forEach(b => { b.style.background="#EEE"; b.style.color="#666"; }); btn.style.background = "var(--accent)"; btn.style.color = "white"; calcEx(); }
        function copyNotice(ri) { const o = orders[ri], items = o.items.map(i => `- ${i.name} x ${i.qty}`).join('\n'); const msg = `ã€SlowOver å‡ºå–®é€šçŸ¥ã€‘\nå–®è™Ÿï¼š#${o.id}\næ—¥æœŸï¼š${o.date}\né›»è©±ï¼š${o.tel}\n\nè¨‚è³¼é …ç›®ï¼š\n${items}\nç¸½è¨ˆé‡‘é¡ï¼šHKD $${o.totalPrice}\n\nğŸ’¸ä»˜æ¬¾æ–¹å¼ï¼š\n${PAY_INFO}\n\n${TERMS}`; navigator.clipboard.writeText(msg); alert("âœ… å·²è¤‡è£½å‡ºå–®é€šçŸ¥"); }
        function copyAskInfo(ri) { const msg = `ã€SlowOver ç´¢å–æ”¶è²¨è³‡æ–™ã€‘\nå–®è™Ÿï¼š#${orders[ri].id}\nè¨‚å–®å·²æº–å‚™å¥½ï¼Œè«‹æä¾›å§“åã€é›»è©±åŠé †è±ç«™é»ã€‚`; navigator.clipboard.writeText(msg); alert("âœ… å·²è¤‡è£½ç´¢å–è³‡æ–™è¨Šæ¯"); }
        function save() { localStorage.setItem('slow_v62_data', JSON.stringify(orders)); localStorage.setItem('slow_v62_serial', serial); }
        function updStatus(ri, k) { orders[ri][k] = !orders[ri][k]; save(); render(); }
        function updInfo(ri, k, v) { orders[ri][k] = v; save(); }
        function delItem(ri, ii) { if(confirm("åˆªé™¤å•†å“ï¼Ÿ")) { orders[ri].items.splice(ii,1); save(); render(); } }
        function delOrder(ri) { if(confirm("å…¨å–®åˆªé™¤ï¼Ÿ")) { orders.splice(ri,1); save(); render(); } }
        function resetSerial() { const v = prompt("å–®è™Ÿèµ·å§‹:", serial); if(v) { serial = parseInt(v); save(); } }
        function switchPage(p, btn) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.querySelectorAll('.page').forEach(el => el.classList.remove('active')); document.getElementById('page-' + p).classList.add('active'); btn.classList.add('active'); if(p === 'buy') renderBuy(); if(p === 'stats') renderStats(); if(p === 'tools') renderQuotes(); }
        async function syncToCloud() { try { const b = new Blob([JSON.stringify(orders)], {type:'text/plain'}); await fetch(GAS_URL, {method:'POST', body:b, mode:'no-cors'}); alert("âœ… æ•¸æ“šå·²ç™¼é€è‡³é›²ç«¯ (å«å•†å“è©³æƒ…)"); } catch(e) { alert("ä¸Šå‚³å¤±æ•—"); } }
        async function syncFromCloud() { try { const r = await fetch(GAS_URL); orders = await r.json(); save(); render(); alert("ä¸‹è¼‰æˆåŠŸ"); } catch(e) { alert("ä¸‹è¼‰å¤±æ•—"); } }
        window.onload = () => { document.getElementById('order-date').valueAsDate = new Date(); addItemRow(); render(); };
    </script>
</body>
</html>
