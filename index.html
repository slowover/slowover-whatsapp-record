<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SlowOver CRM V91.7</title>
    <style>
        :root { --primary: #D4A373; --bg: #FAF7F2; --text: #5F4B32; --accent: #8EAD91; --blue: #5C7CFA; --green: #40C057; --purple: #7048E8; --red: #E03131; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px 120px 15px; }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid #EEE; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px 0; text-align: center; font-size: 11px; color: #999; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        input, select, button { width: 100%; padding: 12px; margin: 4px 0; border: 1px solid #E0D7CC; border-radius: 10px; font-size: 14px; -webkit-appearance: none; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; touch-action: manipulation; }
        button:active { opacity: 0.7; transform: scale(0.98); }
        .order-card { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #EEE; border-left: 8px solid var(--primary); position: relative; }
        .tag { font-size: 10px; padding: 6px 12px; border-radius: 6px; display: inline-block; cursor: pointer; margin-right: 5px; margin-top: 8px; font-weight: bold; border: 1px solid #DDD; background: #FFF; color: #999; }
        .tag.active.buy { background: #FFD43B; color: #856404; border-color: #FFD43B; }
        .tag.active.arr { background: var(--blue); color: white; border-color: var(--blue); }
        .st-btn { font-size: 10px; padding: 10px 0; border-radius: 8px; background: #F8F9FA; color: #BBB; border: 1px solid #EEE; text-align: center; font-weight: bold; cursor: pointer; }
        .st-btn.active.paid { background: var(--green); color: white; border-color: var(--green); }
        .st-btn.active.ship { background: var(--blue); color: white; border-color: var(--blue); }
        #sync-status { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 5px 12px; border-radius: 20px; font-size: 10px; display: none; z-index: 2000; }
        .log-item { font-size: 12px; padding: 8px; border-bottom: 1px solid #F1F1F1; display: flex; justify-content: space-between; color: #666; }
    </style>
</head>
<body>

    <div id="sync-status">â˜ï¸ åŒæ­¥ä¸­...</div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('main', this)">ğŸ“ è¨‚å–®</div>
        <div class="nav-item" onclick="switchPage('buy', this)">ğŸ›ï¸ æ¡è³¼</div>
        <div class="nav-item" onclick="switchPage('stats', this)">ğŸ“Š çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchPage('tools', this)">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="page-main" class="page active">
        <div class="card">
            <h3 style="margin:0 0 10px 0;">ğŸ“ æ–°å¢è¨‚å–®</h3>
            <input type="date" id="order-date">
            <input type="tel" id="cust-tel" placeholder="å®¢æˆ¶ WhatsApp">
            <div id="new-items-area"></div>
            <button onclick="addInputRow()" style="background:#F1F3F5; color:#666; border:1px dashed #CCC; margin-top:10px;">+ å¢åŠ å•†å“é …ç›®</button>
            <button id="save-btn" onclick="saveOrder()" style="height:55px; margin-top:15px; background:var(--accent); font-size:16px;">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥</button>
        </div>
        <div id="order-list"></div>
    </div>

    <div id="page-buy" class="page">
        <div class="card" id="buy-summary"></div>
    </div>

    <div id="page-stats" class="page">
        <div class="card">
            <input type="text" id="stat-search" placeholder="æœå°‹é›»è©±/å–®è™Ÿ/å•†å“..." oninput="renderStats()">
        </div>
        <div id="stat-total" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;"></div>
        <div id="stat-list"></div>
    </div>

    <div id="page-tools" class="page">
        <div class="card">
            <h3>â˜ï¸ é›²ç«¯åŒæ­¥</h3>
            <p id="last-sync" style="font-size:12px; color:#999;">å°šæœªåŒæ­¥æ•¸æ“š</p>
            <button onclick="syncFromCloud()" style="background:var(--blue); padding:15px;">ğŸ”„ å¾é›²ç«¯ä¸‹è¼‰æœ€æ–°æ•¸æ“š</button>
        </div>
        <div class="card">
            <h3>ğŸ’° åŒ¯ç‡åŠ©æ‰‹ (è‡ªè¨‚ % æ‰‹çºŒè²»)</h3>
            <div style="display:flex; gap:5px; align-items:center;">
                <select id="ex-cur" style="flex:1;" onchange="calcEx()">
                    <option value="0.00585">éŸ“å¹£ KRW (0.00585)</option>
                    <option value="0.0525">æ—¥å¹£ JPY (0.0525)</option>
                    <option value="0.222">æ³°å¹£ THB (0.222)</option>
                </select>
                <div style="flex:1; display:flex; align-items:center; background:#F8F9FA; border-radius:10px; padding:0 10px; border:1px solid #E0D7CC;">
                    <input type="number" id="ex-fee-custom" value="5" oninput="calcEx()" style="border:none; background:transparent; margin:0; padding:10px; text-align:right; width:60px;">
                    <span style="font-size:14px; font-weight:bold;">%</span>
                </div>
            </div>
            <input type="number" id="ex-val" placeholder="è¼¸å…¥å¤–å¹£é‡‘é¡" oninput="calcEx()">
            <div id="ex-res" style="font-size:36px; text-align:center; color:var(--primary); font-weight:bold; margin:15px 0; border: 2px dashed #E0D7CC; border-radius:15px; padding:10px;">$0.00</div>
            <button onclick="logEx()" style="background:var(--accent); padding:15px;">ğŸ“Œ ç´€éŒ„æ­¤å ±åƒ¹</button>
            <div style="margin-top:20px;">
                <h4 style="margin:0 0 10px 0; font-size:14px; color:#999;">ğŸ•’ æ­·å²è¨˜éŒ„ (æœ€è¿‘20æ¢)</h4>
                <div id="ex-history-list" class="card" style="padding:5px; box-shadow:none; border:1px solid #F1F1F1; max-height:200px; overflow-y:auto;"></div>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "ä½ çš„GASç¶²å€"; 
        const PAY_MSG = `ğŸ’¸ä»˜æ¬¾æ–¹å¼ï¼š\nPayMeï¼š\nhttps://qr.payme.hsbc.com.hk/2/Ui316pJ5T8b428yzTSbr4J\n\nå¿«é€Ÿæ”¯ä»˜ç³»çµ±è­˜åˆ¥ç¢¼FPS IDï¼š105249023\nåç¨±ï¼šslow over\n\nâš ï¸ æ³¨æ„äº‹é …ï¼š\n24å°æ™‚å…§å®Œæˆä»˜æ¬¾ä¸¦å›å‚³å…¥æ•¸æˆªåœ–\næˆªåœ–è«‹å‚™è¨»é›»è©±è™Ÿç¢¼ä»¥ä¾¿å°è³¬`;
        const TERMS = `ä¸‹å–®å³åŒæ„ä»¥ä¸‹æ¢æ¬¾ï¼š\n1. 24å°æ™‚å…§å®Œæˆä»˜æ¬¾ä¸¦å›å‚³å…¥æ•¸æˆªåœ–ã€‚\n2. æˆªåœ–è«‹å‚™è¨»æˆ–è¨Šæ¯é›»è©±è™Ÿç¢¼ä»¥ä¾¿å°è³¬ã€‚\n3. è¨‚å–®ä¸€ç¶“ç¢ºèªï¼Œä¸è¨­å–æ¶ˆã€é€€æ›æˆ–æ›´æ”¹ã€‚\n4. å¦‚é‡å•†å“ç¼ºè²¨ï¼Œå°‡æœƒå…¨æ•¸é€€æ¬¾ã€‚\n5. ä¸€èˆ¬é è¨‚éœ€æ™‚ 7-30 å€‹å·¥ä½œå¤©ï¼Œä¸æ¥æ€¥å–®ã€‚\n6. é‹é€éç¨‹å¦‚æœ‰æå£é¢¨éšªéœ€ç”±è²·å®¶æ‰¿æ“”ã€‚\n7. SLOWOVER ä¿ç•™æœ€çµ‚æ±ºå®šæ¬Šã€‚æ„Ÿè¬æ”¯æŒ SLOWOVERï¼`;

        let orders = []; let serial = 300; let exLogs = JSON.parse(localStorage.getItem('slow_ex_v5')) || [];

        window.onload = async () => {
            document.getElementById('order-date').valueAsDate = new Date();
            addInputRow(); await syncFromCloud(); renderExLogs();
        };

        async function syncFromCloud() {
            try {
                document.getElementById('sync-status').style.display = 'block';
                const r = await fetch(`${GAS_URL}?t=${Date.now()}`);
                const res = await r.json();
                orders = res.orders || []; serial = res.nextSerial || 300;
                render(); renderBuy(); renderStats();
                document.getElementById('last-sync').innerText = "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleTimeString();
                document.getElementById('sync-status').style.display = 'none';
            } catch(e) { alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¶²å€ã€‚"); }
        }

        async function autoPush() {
            document.getElementById('sync-status').style.display = 'block';
            await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ orders, nextSerial: serial }) });
            setTimeout(() => { document.getElementById('sync-status').style.display = 'none'; }, 800);
        }

        function calcEx() {
            const rate = parseFloat(document.getElementById('ex-cur').value);
            const feePercent = parseFloat(document.getElementById('ex-fee-custom').value) || 0;
            const amount = parseFloat(document.getElementById('ex-val').value) || 0;
            const feeMultiplier = 1 + (feePercent / 100);
            const result = amount * rate * feeMultiplier;
            document.getElementById('ex-res').innerText = `$${result.toFixed(2)}`;
        }

        function logEx() {
            const res = document.getElementById('ex-res').innerText;
            const val = document.getElementById('ex-val').value;
            const cur = document.getElementById('ex-cur').options[document.getElementById('ex-cur').selectedIndex].text.split(' ')[0];
            if(res === "$0.00" || !val) return;
            
            const logEntry = {
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                detail: `${val}${cur} â” ${res}`
            };
            exLogs.unshift(logEntry);
            if(exLogs.length > 20) exLogs.pop();
            localStorage.setItem('slow_ex_v5', JSON.stringify(exLogs));
            renderExLogs();
        }

        function renderExLogs() {
            const list = document.getElementById('ex-history-list');
            list.innerHTML = exLogs.length ? exLogs.map(l => `
                <div class="log-item">
                    <span>${l.detail}</span>
                    <span style="color:#CCC;">${l.time}</span>
                </div>
            `).join('') : '<div style="text-align:center; color:#CCC; padding:10px;">å°šç„¡è¨˜éŒ„</div>';
        }

        function saveOrder() {
            const tel = document.getElementById('cust-tel').value.trim();
            if(!tel) return alert("è«‹è¼¸å…¥é›»è©±");
            const btn = document.getElementById('save-btn');
            btn.disabled = true;

            let its = [];
            document.querySelectorAll('.item-row').forEach(r => {
                const n = r.querySelector('.i-n').value;
                const p = parseFloat(r.querySelector('.i-p').value) || 0;
                const q = parseInt(r.querySelector('.i-q').value) || 1;
                if(n) its.push({ name: n, price: p, qty: q, cost: 0, bought: false, arrived: false });
            });

            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const id = `WS${new Date().getFullYear().toString().slice(-2)}${months[new Date().getMonth()]}${serial}`;
            
            orders.push({ id, date: document.getElementById('order-date').value, tel, items: its, paid: false, shipped: false, refunded: false, address: "" });
            serial++; render(); autoPush();

            let cd = 5;
            const iv = setInterval(() => {
                btn.innerText = `å†·å»ä¸­ (${cd}s)...`;
                if(--cd < 0) { clearInterval(iv); btn.disabled = false; btn.innerText = "ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥"; }
            }, 1000);

            document.getElementById('cust-tel').value = ""; document.getElementById('new-items-area').innerHTML = ""; addInputRow();
        }

        function render() {
            const list = document.getElementById('order-list');
            list.innerHTML = orders.slice().reverse().map((o, idx) => {
                const ri = orders.indexOf(o);
                const allB = o.items.length > 0 && o.items.every(it => it.bought);
                const allA = o.items.length > 0 && o.items.every(it => it.arrived);
                let st = o.address ? "å·²å¯„å‡º" : (allA ? "å…¨éƒ¨å·²åˆ°æ¸¯ï¼Œæœªå¯„å‡º" : (allB ? "å·²è²·é½Šï¼Œæœªåˆ°æ¸¯" : ""));

                return `
                <div class="order-card">
                    <span style="position:absolute; top:10px; right:10px; color:#CCC; padding:5px;" onclick="if(confirm('åˆªé™¤ï¼Ÿ')){orders.splice(${ri},1); render(); autoPush();}">Ã—</span>
                    <div style="font-size:10px; color:#AAA;">#${o.id} | ${o.date}</div>
                    <div style="font-size:18px; font-weight:bold; margin:5px 0;">ğŸ“ ${o.tel}</div>
                    <span style="font-size:12px; font-weight:bold; color:var(--purple);">${st}</span>
                    ${o.items.map((it, ii) => `
                        <div style="background:#FCFAf7; padding:8px; border-radius:8px; margin:5px 0; border:1px solid #F0E6D8;">
                            <div style="font-size:14px;">${it.name} x${it.qty} ($${it.price})</div>
                            <span class="tag buy ${it.bought?'active':''}" onclick="togIt(${ri},${ii},'bought')">${it.bought?'å·²è²·':'æœªè²·'}</span>
                            <span class="tag arr ${it.arrived?'active':''}" onclick="togIt(${ri},${ii},'arrived')">${it.arrived?'å·²åˆ°æ¸¯':'æœªåˆ°'}</span>
                        </div>
                    `).join('')}
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-top:10px;">
                        <div class="st-btn paid ${o.paid?'active':''}" onclick="updO(${ri},'paid')">å·²ä»˜æ¬¾</div>
                        <div class="st-btn ship ${o.shipped?'active':''}" onclick="updO(${ri},'shipped')">å·²å¯„å‡º</div>
                        <div class="st-btn" onclick="updO(${ri},'refunded')" style="color:${o.refunded?'white':'red'}; background:${o.refunded?'red':''}">å·²é€€æ¬¾</div>
                    </div>
                    <input type="text" placeholder="é †è±é»ç¢¼/å–®è™Ÿ" value="${o.address}" onchange="orders[${ri}].address=this.value; render(); autoPush();" style="font-size:12px; margin-top:10px;">
                    <div style="display:flex; gap:5px; margin-top:8px;">
                        <button onclick="copyB(${ri})" style="flex:1; font-size:11px; background:var(--accent); padding:10px;">ğŸ“‹ å‡ºå–®é€šçŸ¥</button>
                        <button onclick="copyA(${ri})" style="flex:1; font-size:11px; background:var(--purple); padding:10px;">ğŸ“‹ ç´¢å–è³‡æ–™</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStats() {
            const q = document.getElementById('stat-search').value.toLowerCase();
            let fil = orders.filter(o => o.tel.includes(q) || o.id.toLowerCase().includes(q) || o.items.some(it => it.name.toLowerCase().includes(q)));
            let tp = 0, tc = 0;
            document.getElementById('stat-list').innerHTML = fil.map(o => {
                const ri = orders.indexOf(o); let op = 0, oc = 0;
                const rows = o.items.map((it, ii) => {
                    op += (it.price * it.qty); oc += (it.cost * it.qty);
                    return `<div style="display:grid; grid-template-columns:2fr 1fr 1.2fr; gap:5px; margin:5px 0; align-items:center;">
                        <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${it.name}</span><span style="color:#999">$${it.price}</span>
                        <input type="number" value="${it.cost}" onchange="orders[${ri}].items[${ii}].cost=parseFloat(this.value)||0; renderStats(); autoPush();" placeholder="æˆæœ¬" style="padding:4px; margin:0;">
                    </div>`;
                }).join('');
                tp += op; tc += oc;
                return `<div class="card" style="font-size:12px;"><b>#${o.id} | ${o.tel}</b>${rows}<div style="text-align:right; font-weight:bold; color:var(--primary); border-top:1px solid #EEE; padding-top:5px;">è¨‚å–®åˆ©æ½¤: $${(op-oc).toFixed(1)}</div></div>`;
            }).join('');
            document.getElementById('stat-total').innerHTML = `<div class="card" style="text-align:center; background:var(--primary); color:white;">ç¸½ç‡Ÿæ¥­é¡<br><b>$${tp.toFixed(1)}</b></div><div class="card" style="text-align:center; background:var(--accent); color:white;">é ä¼°ç¸½åˆ©æ½¤<br><b>$${(tp-tc).toFixed(1)}</b></div>`;
        }

        function renderBuy() {
            let m = {};
            orders.forEach(o => o.items.forEach(it => {
                if(!m[it.name]) m[it.name] = { t: 0, b: 0 };
                m[it.name].t += it.qty; if(it.bought) m[it.name].b += it.qty;
            }));
            let h = "<h3>ğŸ›ï¸ æ¡è³¼æ¸…å–® (ä¸æ¶ˆå¤±)</h3>";
            for(let n in m) {
                const ok = m[n].b >= m[n].t;
                h += `<div style="padding:12px; border-bottom:1px solid #EEE; background:${ok?'#F8F9FA':''}"><b>${n}</b><br><span style="color:${ok?'var(--accent)':'var(--red)'}; font-weight:bold;">å·²è²·: ${m[n].b} / ç¸½éœ€æ±‚: ${m[n].t}</span></div>`;
            }
            document.getElementById('buy-summary').innerHTML = h || '<div class="card" style="text-align:center; color:#CCC;">å°šç„¡æ¡è³¼é …ç›®</div>';
        }

        function togIt(oi, ii, k) { orders[oi].items[ii][k] = !orders[oi].items[ii][k]; render(); renderBuy(); autoPush(); }
        function updO(oi, k) { orders[oi][k] = !orders[oi][k]; render(); autoPush(); }
        function addInputRow() {
            const d = document.createElement('div'); d.className = 'item-row';
            d.innerHTML = `<div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="i-n" placeholder="å•†å“å" style="flex:2"><input type="number" class="i-q" value="1" style="flex:0.5"><input type="number" class="i-p" placeholder="å”®åƒ¹" style="flex:1"></div>`;
            document.getElementById('new-items-area').appendChild(d);
        }
        function switchPage(p, btn) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active'); btn.classList.add('active');
            if(p === 'buy') renderBuy(); if(p === 'stats') renderStats();
        }
        function copyB(idx) {
            const o = orders[idx];
            const txt = `ã€SlowOver å‡ºå–®é€šçŸ¥ã€‘\nå–®è™Ÿï¼š#${o.id}\né›»è©±ï¼š${o.tel}\n\nè¨‚å–®é …ç›®ï¼š\n${o.items.map(it => `- ${it.name} x${it.qty}`).join('\n')}\nç¸½é‡‘é¡ï¼šHKD $${o.items.reduce((s,it)=>s+(it.price*it.qty),0)}\n\n${PAY_MSG}\n\n${TERMS}`;
            navigator.clipboard.writeText(txt).then(() => alert("å·²è¤‡è£½å‡ºå–®é€šçŸ¥"));
        }
        function copyA(idx) {
            const o = orders[idx];
            const txt = `ã€SlowOver æ”¶è²¨è³‡æ–™ç™»è¨˜ã€‘\nå–®è™Ÿï¼š#${o.id}\nè²¨å“å·²é½Šå‚™ï¼Œè«‹æä¾›ä»¥ä¸‹è³‡æ–™ä»¥ä¾¿å¯„å‡ºï¼š\n\næ”¶ä»¶äººå§“åï¼š\næ”¶ä»¶äººé›»è©±ï¼š\né †è±ç«™/æ™ºèƒ½æ«ƒç·¨è™ŸåŠåœ°å€ï¼š\n\næ„Ÿè¬æ”¯æŒï¼ğŸŒ»`;
            navigator.clipboard.writeText(txt).then(() => alert("å·²è¤‡è£½è³‡æ–™æ ¼å¼"));
        }
    </script>
</body>
</html>
