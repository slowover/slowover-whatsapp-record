<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SlowOver CRM V91.16</title>
    <style>
        :root { --primary: #D4A373; --bg: #FAF7F2; --text: #5F4B32; --accent: #8EAD91; --blue: #5C7CFA; --green: #40C057; --purple: #7048E8; --red: #E03131; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px 120px 15px; }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; padding-bottom: env(safe-area-inset-bottom); border-top: 1px solid #EEE; z-index: 1000; }
        .nav-item { flex: 1; padding: 18px 0; text-align: center; font-size: 11px; color: #999; font-weight: bold; }
        .nav-item.active { color: var(--primary); }
        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        input, select, button { width: 100%; padding: 14px; margin: 4px 0; border: 1px solid #E0D7CC; border-radius: 10px; font-size: 14px; -webkit-appearance: none; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        .order-card { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #EEE; border-left: 8px solid var(--primary); position: relative; }
        
        /* çµ±è¨ˆé é¢å°ˆç”¨æ¨£å¼ - ç¢ºä¿æ‰‹æ©Ÿé¡¯ç¤º */
        .stat-order-box { border: 1px solid #F0E6D8; padding: 10px; border-radius: 12px; margin-bottom: 10px; background: #FFF; }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #F9F9F9; }
        .cost-input { width: 80px !important; padding: 5px !important; text-align: right; margin: 0 !important; background: #F1F3F5 !important; border: none !important; }
        
        #sync-status { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 8px 15px; border-radius: 20px; font-size: 11px; display: none; z-index: 2000; }
    </style>
</head>
<body>

    <div id="sync-status">â˜ï¸ è™•ç†ä¸­...</div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('main', this)">ğŸ“ è¨‚å–®</div>
        <div class="nav-item" onclick="switchPage('buy', this)">ğŸ›ï¸ æ¡è³¼</div>
        <div class="nav-item" onclick="switchPage('stats', this)">ğŸ“Š çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchPage('tools', this)">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="page-main" class="page active">
        <div class="card">
            <h3>ğŸ“ æ–°å¢è¨‚å–®</h3>
            <input type="date" id="order-date">
            <input type="tel" id="cust-tel" placeholder="å®¢æˆ¶ WhatsApp é›»è©±">
            <div id="new-items-area"></div>
            <button onclick="addInputRow()" style="background:#F1F3F5; color:#666; border:1px dashed #CCC;">+ å¢åŠ å•†å“é …ç›®</button>
            <button id="save-btn" onclick="saveOrder()" style="height:55px; margin-top:15px; background:var(--accent);">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥åˆ°é›²ç«¯</button>
        </div>
        <div id="order-list"></div>
    </div>

    <div id="page-buy" class="page">
        <div class="card" id="buy-summary"></div>
    </div>

    <div id="page-stats" class="page">
        <div class="card">
            <label style="font-size:12px; color:#999;">å¿«é€Ÿæœå°‹å–®è™Ÿ/é›»è©±/å•†å“</label>
            <input type="text" id="stat-search" placeholder="è¼¸å…¥é—œéµå­—..." oninput="renderStats()">
        </div>
        <div id="stat-total" style="display:flex; gap:10px; margin-bottom:12px;"></div>
        <div id="stat-list"></div>
    </div>

    <div id="page-tools" class="page">
        <div class="card">
            <h3>â˜ï¸ æ•¸æ“šåŒæ­¥</h3>
            <p id="last-sync" style="font-size:12px; color:#999;">å°šæœªåŒæ­¥</p>
            <button onclick="syncFromCloud()" style="background:var(--blue); padding:15px;">ğŸ”„ å¾é›²ç«¯è¼‰å…¥æœ€æ–°æ•¸æ“š</button>
        </div>
        <div class="card">
            <h3>ğŸ”¢ å–®è™Ÿæµæ°´è™Ÿç®¡ç†</h3>
            <div style="display:flex; gap:10px; align-items:center;">
                <span style="flex:1;">ä¸‹ä¸€å€‹å–®è™Ÿæµæ°´:</span>
                <input type="number" id="manual-serial" style="flex:1; background:#F8F9FA;">
            </div>
            <button onclick="updateSerial()" style="background:var(--text); margin-top:10px;">æ›´æ–°æµæ°´è™Ÿ</button>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxPku0qTD-XQvctzBYfHQNflwBn0QH-WjwTzPwfWMDsyMvym94i0f-MlXtUbHpEjJZaRA/exec"; 
        let orders = []; let serial = 300;

        window.onload = () => {
            document.getElementById('order-date').valueAsDate = new Date();
            addInputRow(); 
            syncFromCloud(); // é€²å…¥å³è¼‰å…¥
        };

        async function syncFromCloud() {
            const status = document.getElementById('sync-status');
            status.style.display = 'block';
            try {
                const r = await fetch(`${GAS_URL}?t=${Date.now()}`);
                const res = await r.json();
                if(res.orders) {
                    orders = res.orders; 
                    serial = res.nextSerial || 300;
                    document.getElementById('manual-serial').value = serial;
                    render(); renderBuy(); renderStats(); // ç¢ºä¿ä¸‰å€‹é é¢åŒæ­¥æ¸²æŸ“
                    document.getElementById('last-sync').innerText = "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleTimeString();
                }
            } catch(e) { 
                console.error("æ‰‹æ©Ÿé€£ç·šé™åˆ¶ï¼šè«‹é—œé–‰ Safari çš„é˜²æ­¢è·¨ç¶²ç«™è¿½è¹¤åŠŸèƒ½");
            }
            status.style.display = 'none';
        }

        async function autoPush() {
            document.getElementById('sync-status').innerText = "â˜ï¸ åŒæ­¥é›²ç«¯...";
            document.getElementById('sync-status').style.display = 'block';
            try {
                await fetch(GAS_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ orders, nextSerial: serial }) });
            } catch(e) {}
            setTimeout(() => { document.getElementById('sync-status').style.display = 'none'; }, 1000);
        }

        function updateSerial() {
            serial = parseInt(document.getElementById('manual-serial').value) || serial;
            autoPush();
            alert("æµæ°´è™Ÿå·²æ›´æ–°");
        }

        // --- ğŸ“Š çµ±è¨ˆé é¢æ ¸å¿ƒé‚è¼¯ ---
        function renderStats() {
            const listDiv = document.getElementById('stat-list');
            const totalDiv = document.getElementById('stat-total');
            if(!listDiv) return;

            const q = (document.getElementById('stat-search').value || "").toLowerCase().trim();
            
            // éæ¿¾é‚è¼¯ï¼šæœå°‹å–®è™Ÿã€é›»è©±ã€å•†å“å
            let filtered = orders.filter(o => {
                return (o.id||"").toLowerCase().includes(q) || 
                       (o.tel||"").includes(q) || 
                       o.items.some(it => (it.name||"").toLowerCase().includes(q));
            });

            let grandTotalProfit = 0;
            let grandTotalRevenue = 0;

            listDiv.innerHTML = filtered.map(o => {
                const oIdx = orders.indexOf(o);
                let orderRevenue = 0;
                let orderCost = 0;

                const itemRows = o.items.map((it, iIdx) => {
                    const rev = it.price * it.qty;
                    const cost = it.cost * it.qty;
                    orderRevenue += rev;
                    orderCost += cost;
                    return `
                        <div class="stat-row">
                            <div style="flex:2;">
                                <div style="font-size:13px; font-weight:bold;">${it.name}</div>
                                <div style="font-size:11px; color:#999;">å”®åƒ¹: $${it.price} x ${it.qty}</div>
                            </div>
                            <div style="flex:1; text-align:right;">
                                <span style="font-size:10px; color:#AAA;">æˆæœ¬</span><br>
                                <input type="number" class="cost-input" value="${it.cost}" 
                                    onchange="updateCost(${oIdx}, ${iIdx}, this.value)">
                            </div>
                        </div>`;
                }).join('');

                const orderProfit = orderRevenue - orderCost;
                grandTotalRevenue += orderRevenue;
                grandTotalProfit += orderProfit;

                return `
                    <div class="stat-order-box">
                        <div style="display:flex; justify-content:space-between; border-bottom:1px dashed #EEE; padding-bottom:5px; margin-bottom:5px;">
                            <span style="font-weight:bold; color:var(--primary);">#${o.id}</span>
                            <span style="font-size:12px;">ğŸ“ ${o.tel}</span>
                        </div>
                        ${itemRows}
                        <div style="text-align:right; margin-top:10px; font-size:13px; font-weight:bold; color:var(--accent);">
                            å–®ç­†åˆ©æ½¤: $${orderProfit.toFixed(1)}
                        </div>
                    </div>`;
            }).join('');

            totalDiv.innerHTML = `
                <div class="card" style="flex:1; background:var(--primary); color:white; text-align:center; padding:10px; border-radius:12px;">
                    <small>ç¸½ç‡Ÿæ”¶</small><br>$${grandTotalRevenue.toFixed(1)}
                </div>
                <div class="card" style="flex:1; background:var(--accent); color:white; text-align:center; padding:10px; border-radius:12px;">
                    <small>ç¸½é ä¼°åˆ©æ½¤</small><br>$${grandTotalProfit.toFixed(1)}
                </div>`;
        }

        function updateCost(oIdx, iIdx, val) {
            orders[oIdx].items[iIdx].cost = parseFloat(val) || 0;
            renderStats(); // å³æ™‚æ›´æ–°åˆ©æ½¤
            autoPush();    // åŒæ­¥åˆ° Google Sheet
        }

        function render() {
            const list = document.getElementById('order-list');
            if(!list) return;
            list.innerHTML = orders.slice().reverse().map((o) => {
                const ri = orders.indexOf(o);
                return `<div class="order-card">
                    <span style="position:absolute; top:10px; right:10px; color:#CCC; padding:10px;" onclick="if(confirm('åˆªé™¤ï¼Ÿ')){orders.splice(${ri},1); render(); autoPush();}">Ã—</span>
                    <div style="font-size:10px; color:#AAA;">#${o.id} | ${o.date}</div>
                    <div style="font-size:18px; font-weight:bold;">ğŸ“ ${o.tel}</div>
                    ${o.items.map((it, ii) => `
                        <div style="background:#FCFAf7; padding:10px; border-radius:12px; margin:6px 0; border:1px solid #F0E6D8;">
                            <div style="font-size:14px; font-weight:bold;">${it.name} x${it.qty}</div>
                            <span class="tag ${it.bought?'active buy':''}" onclick="togIt(${ri},${ii},'bought')">å·²è²·</span>
                            <span class="tag ${it.arrived?'active arr':''}" onclick="togIt(${ri},${ii},'arrived')">å·²åˆ°æ¸¯</span>
                        </div>
                    `).join('')}
                    <div style="margin-top:10px;">
                        <input type="text" placeholder="æ”¶ä»¶äºº/åœ°å€/å–®è™Ÿ" value="${o.address||''}" onchange="orders[${ri}].address=this.value; autoPush();" style="background:#f9f9f9;">
                    </div>
                </div>`;
            }).join('');
        }

        function saveOrder() {
            const tel = document.getElementById('cust-tel').value.trim();
            if(!tel) return alert("è«‹è¼¸å…¥é›»è©±");
            let its = [];
            document.querySelectorAll('.item-row').forEach(r => {
                const n = r.querySelector('.i-n').value.trim();
                const p = parseFloat(r.querySelector('.i-p').value) || 0;
                const q = parseInt(r.querySelector('.i-q').value) || 1;
                if(n) its.push({ name: n, price: p, qty: q, cost: 0, bought: false, arrived: false });
            });
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const id = `WS${new Date().getFullYear().toString().slice(-2)}${months[new Date().getMonth()]}${serial}`;
            orders.push({ id, date: document.getElementById('order-date').value, tel, items: its, paid: false, shipped: false, address: "" });
            serial++; 
            document.getElementById('manual-serial').value = serial;
            render(); renderStats(); autoPush();
            document.getElementById('cust-tel').value = ""; document.getElementById('new-items-area').innerHTML = ""; addInputRow();
        }

        function togIt(oi, ii, k) { orders[oi].items[ii][k] = !orders[oi].items[ii][k]; render(); autoPush(); }
        
        function addInputRow() {
            const d = document.createElement('div'); d.className = 'item-row';
            d.innerHTML = `<div style="display:flex; gap:5px; margin-bottom:5px;"><input type="text" class="i-n" placeholder="å•†å“å" style="flex:2"><input type="number" class="i-q" value="1" style="flex:0.6;"><input type="number" class="i-p" placeholder="å”®åƒ¹" style="flex:1"></div>`;
            document.getElementById('new-items-area').appendChild(d);
        }

        function switchPage(p, btn) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-'+p).classList.add('active'); btn.classList.add('active');
            if(p === 'stats') renderStats(); // åˆ‡æ›åˆ°çµ±è¨ˆé æ™‚å¼·åˆ¶åˆ·æ–°æœå°‹åˆ—è¡¨
        }
    </script>
</body>
</html>
