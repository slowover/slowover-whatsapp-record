<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/clouds/512/shopping-bag.png">
    <title>SlowOver CRM V64.1</title>
    <style>
        :root { 
            --primary: #D4A373; --bg: #FAF7F2; --text: #5F4B32; 
            --accent: #8EAD91; --blue: #5C7CFA; --red: #E03131; 
            --green: #40C057; --gray: #999; --yellow: #FFD43B;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { -webkit-user-select: none; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        input, textarea { -webkit-user-select: text !important; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 20px 15px calc(var(--safe-bottom) + 100px) 15px; }
        
        /* å°è¦½åˆ— */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(15px); display: flex; padding-bottom: var(--safe-bottom); border-top: 1px solid #EEE; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px 0; text-align: center; font-size: 11px; color: var(--gray); font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        .card { background: white; padding: 18px; border-radius: 22px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        
        input, select, button { width: 100%; padding: 14px; margin: 5px 0; border: 1px solid #E0D7CC; border-radius: 12px; font-size: 15px; outline: none; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        .order-card { background: white; padding: 18px; border-radius: 25px; margin-bottom: 15px; border-left: 8px solid var(--primary); }
        .item-box { background: #FCFAf7; padding: 12px; border-radius: 15px; margin: 8px 0; border: 1px solid #F0E6D8; position: relative; }
        
        .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin: 10px 0; }
        .st-btn { font-size: 10px; padding: 10px 0; border-radius: 10px; background: #F8F9FA; color: #BBB; border: 1px solid #EEE; text-align: center; cursor: pointer; }
        .st-btn.active.paid { background: var(--green); color: white; border-color: var(--green); }
        .st-btn.active.shipped { background: var(--blue); color: white; border-color: var(--blue); }
        .st-btn.active.refunded { background: var(--red); color: white; border-color: var(--red); }
        
        .tag-btn { display: inline-block; padding: 5px 10px; border-radius: 8px; font-size: 11px; margin-top: 8px; font-weight: bold; cursor: pointer; }
        .tag-bought { background: var(--yellow); color: #856404; }
        .tag-arrived { background: #E7F5FF; color: var(--blue); }
        
        /* æ¡è³¼é ä¿®å¾©ä½ˆå±€ */
        .buy-item { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 10px; }
        .buy-info { flex: 1; }
        .buy-action { width: 85px; flex-shrink: 0; }

        .history-list { max-height: 200px; overflow-y: auto; background: #F9F9F9; border-radius: 10px; }
        .history-item { font-size: 12px; padding: 10px; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; }
        .info-tag { font-size: 11px; background: #F3F6F9; padding: 12px; border-radius: 15px; margin-top: 10px; border-left: 4px solid var(--blue); line-height: 1.5; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('main', this)">ğŸ“ è¨‚å–®</div>
        <div class="nav-item" onclick="switchPage('buy', this)">ğŸ›ï¸ æ¡è³¼</div>
        <div class="nav-item" onclick="switchPage('stats', this)">ğŸ“Š çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchPage('tools', this)">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="page-main" class="page active">
        <h2 style="padding-left:10px;">æ–°è¨‚å–®</h2>
        <div class="card">
            <input type="date" id="order-date">
            <input type="tel" id="cust-tel" placeholder="å®¢æˆ¶é›»è©± (WhatsApp)">
            <div id="items-area"></div>
            <button onclick="addItemRow()" style="background:#F1F3F5; color:var(--text); margin-top:10px;">+ æ–°å¢å•†å“é …ç›®</button>
            <button onclick="saveOrder()" style="height:60px; margin-top:15px; font-size:18px; background:var(--accent)">ğŸ’¾ å„²å­˜è¨‚å–® (ä¸ç™¼é€)</button>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="page-buy" class="page">
        <h2 style="padding-left:10px;">ğŸ›ï¸ å¾…è™•ç†æ¡è³¼</h2>
        <div id="buy-container"></div>
    </div>

    <div id="page-stats" class="page">
        <h2 style="padding-left:10px;">ğŸ“Š çµ±è¨ˆèˆ‡æœå°‹</h2>
        <div class="card">
            <input type="text" id="stat-search" placeholder="ğŸ” æœå°‹é›»è©±ã€å–®è™Ÿã€å•†å“..." oninput="render()">
        </div>
        <div id="stats-summary"></div>
        <div id="stats-list"></div>
    </div>

    <div id="page-tools" class="page">
        <h2 style="padding-left:10px;">âš™ï¸ ç³»çµ±è¨­å®š</h2>
        <div class="card">
            <h3>â˜ï¸ é›²ç«¯åŒæ­¥ç³»çµ±</h3>
            <p style="font-size:12px; color:var(--gray); margin-bottom:10px;">å·²é€£æ¥è‡³ Google Sheet å‚™ä»½</p>
            <div style="display:flex; gap:10px;">
                <button onclick="syncToCloud()" style="background:var(--blue)">ä¸Šå‚³æ•¸æ“š</button>
                <button onclick="syncFromCloud()" style="background:var(--accent)">ä¸‹è¼‰æ•¸æ“š</button>
            </div>
        </div>
        <div class="card">
            <h3>ğŸ’° åŒ¯ç‡åŠ©æ‰‹ (æœ€è¿‘30æ¬¡)</h3>
            <select id="cur-sel" onchange="calcEx()">
                <option value="KRW">éŸ“å¹£ (KRW) 0.00585</option>
                <option value="JPY">æ—¥å¹£ (JPY) 0.0525</option>
                <option value="THB">æ³°å¹£ (THB) 0.222</option>
            </select>
            <input type="number" id="ex-in" placeholder="è¼¸å…¥å¤–å¹£é‡‘é¡" oninput="calcEx()">
            <div style="display:flex; gap:5px; margin:5px 0;">
                <button id="fee3" onclick="setFee(1.03, this)" style="background:var(--accent)">+3% æ‰¹ç™¼</button>
                <button id="fee5" onclick="setFee(1.05, this)" style="background:#EEE; color:#666;">+5% é›¶å”®</button>
            </div>
            <div id="ex-res" style="font-size:24px; font-weight:bold; color:var(--primary); text-align:center;"></div>
            <div id="calc-history" class="history-list" style="margin-top:10px;"></div>
        </div>
        <div class="card">
            <button onclick="resetSerial()">ğŸ”¢ ä¿®æ”¹æµæ°´è™Ÿèµ·å§‹å€¼</button>
            <button onclick="exportJSON()" style="background:#F1F3F5; color:#333; margin-top:10px;">ğŸ“¥ å°å‡ºæœ¬åœ°å‚™ä»½</button>
        </div>
    </div>

    <script>
        // *** GAS ç¶²å€å·²åµŒå…¥ ***
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyCRh9BCDLiMkj3099u2ZPOtbTUA17uryJ80iKjIdICkUZuA94lOuptNJgzJpVWjaGzUA/exec"; 

        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        let orders = JSON.parse(localStorage.getItem('slow_v62_data') || '[]');
        let serial = parseInt(localStorage.getItem('slow_v62_serial') || '300');
        let calcHistory = JSON.parse(localStorage.getItem('slow_v62_calcs') || '[]');
        let currentFee = 1.03;
        let rates = { KRW: 0.00585, JPY: 0.0525, THB: 0.222 };

        // å®Œæ•´ä¸è®Šçš„ä»˜æ¬¾èˆ‡æ¢æ¬¾
        const PAYMENT_INFO = `ğŸ’¸ä»˜æ¬¾æ–¹å¼ï¼š
PayMeï¼š
https://qr.payme.hsbc.com.hk/2/Ui316pJ5T8b428yzTSbr4J

FPS:
å¿«é€Ÿæ”¯ä»˜ç³»çµ±è­˜åˆ¥ç¢¼FPS IDï¼š105249023
åç¨±ï¼šslow over

âš ï¸ æ³¨æ„äº‹é …ï¼š
- 24å°æ™‚å…§å®Œæˆä»˜æ¬¾ä¸¦å›å‚³å…¥æ•¸æˆªåœ–
- æˆªåœ–è«‹å‚™è¨»é›»è©±è™Ÿç¢¼ä»¥ä¾¿å°è³¬`;

        const FULL_TERMS = `ä¸‹å–®å³åŒæ„ä»¥ä¸‹æ¢æ¬¾ï¼š
1. 24å°æ™‚å…§å®Œæˆä»˜æ¬¾ä¸¦å›å‚³å…¥æ•¸æˆªåœ–ã€‚
2. æˆªåœ–è«‹å‚™è¨»æˆ–è¨Šæ¯é›»è©±è™Ÿç¢¼ä»¥ä¾¿å°è³¬ã€‚
3. è¨‚å–®ä¸€ç¶“ç¢ºèªï¼Œä¸è¨­å–æ¶ˆã€é€€æ›æˆ–æ›´æ”¹ã€‚
4. å¦‚é‡å•†å“ç¼ºè²¨ï¼Œå°‡æœƒå…¨æ•¸é€€æ¬¾ã€‚
5. ä¸€èˆ¬é è¨‚éœ€æ™‚ 7-30 å€‹å·¥ä½œå¤©ï¼Œä¸æ¥æ€¥å–®ã€‚
6. é‹é€éç¨‹å¦‚æœ‰æå£é¢¨éšªéœ€ç”±è²·å®¶æ‰¿æ“”ã€‚
7. SLOWOVER ä¿ç•™æœ€çµ‚æ±ºå®šæ¬Šã€‚

ğŸŒ»ğŸŒ»æ„Ÿè¬æ”¯æŒ SLOWOVERï¼ğŸŒ»ğŸŒ»`;

        function addItemRow() {
            const div = document.createElement('div');
            div.className = 'item-box';
            div.innerHTML = `<input type="text" placeholder="å•†å“åç¨±" class="in-n"><div style="display:flex; gap:5px;"><input type="number" value="1" class="in-q" style="flex:1"><input type="number" placeholder="å”®åƒ¹" class="in-p" style="flex:2"><input type="number" placeholder="æˆæœ¬" class="in-c" style="flex:2"></div><button onclick="this.parentElement.remove()" style="position:absolute; top:5px; right:10px; width:auto; background:none; color:var(--red); font-size:12px;">âœ•</button>`;
            document.getElementById('items-area').appendChild(div);
        }

        function saveOrder() {
            const tel = document.getElementById('cust-tel').value;
            const rows = document.querySelectorAll('.item-box');
            if(!tel || rows.length === 0) return alert("è³‡æ–™ä¸å®Œæ•´");
            let items = [], total = 0;
            rows.forEach(r => {
                const n = r.querySelector('.in-n').value, q = parseInt(r.querySelector('.in-q').value) || 1, p = parseFloat(r.querySelector('.in-p').value) || 0, c = parseFloat(r.querySelector('.in-c').value) || 0;
                if(n) { items.push({name:n, qty:q, price:p, cost:c, bought:false, arrived:false}); total += (q * p); }
            });
            const id = `WS${new Date().getFullYear().toString().slice(-2)}${MONTHS[new Date().getMonth()]}${serial++}`;
            orders.push({ id, date: document.getElementById('order-date').value, tel, items, totalPrice: total, paid:false, shipped:false, refunded:false, address: "", sfNo: "" });
            localStorage.setItem('slow_v62_data', JSON.stringify(orders));
            localStorage.setItem('slow_v62_serial', serial);
            alert("è¨‚å–®å·²å„²å­˜ï¼");
            location.reload();
        }

        async function copyNotice(idx) {
            const o = orders[idx];
            let itemStr = "";
            o.items.forEach(i => itemStr += `- ${i.name} x ${i.qty}\n`);
            const msg = `ã€SlowOver å‡ºå–®é€šçŸ¥ã€‘\nå–®è™Ÿï¼š#${o.id}\næ—¥æœŸï¼š${o.date}\né›»è©±ï¼š${o.tel}\n\nè¨‚è³¼é …ç›®ï¼š\n${itemStr}ç¸½è¨ˆé‡‘é¡ï¼šHKD $${o.totalPrice}\n\n${PAYMENT_INFO}\n\n${FULL_TERMS}`;
            try {
                await navigator.clipboard.writeText(msg);
                alert("âœ… å®Œæ•´é€šçŸ¥å…§å®¹å·²è¤‡è£½ï¼");
            } catch (err) {
                const textArea = document.createElement("textarea");
                textArea.value = msg; document.body.appendChild(textArea);
                textArea.select(); document.execCommand('copy');
                document.body.removeChild(textArea);
                alert("âœ… å®Œæ•´é€šçŸ¥å…§å®¹å·²è¤‡è£½ï¼");
            }
        }

        async function syncToCloud() {
            try {
                const blob = new Blob([JSON.stringify(orders)], {type: 'text/plain'});
                await fetch(GAS_URL, { method: 'POST', body: blob, mode: 'no-cors' });
                alert("âœ… ä¸Šå‚³æŒ‡ä»¤å·²ç™¼é€ï¼\nè«‹æª¢æŸ¥ Google Sheet å…§å®¹æ˜¯å¦å·²æ›´æ–°ã€‚");
            } catch(e) { alert("âŒ åŒæ­¥å¤±æ•—: " + e); }
        }

        async function syncFromCloud() {
            try {
                const res = await fetch(GAS_URL);
                const data = await res.json();
                if(data && Array.isArray(data)) {
                    orders = data;
                    if(orders.length > 0) {
                        const lastId = orders[orders.length-1].id;
                        const lastNum = parseInt(lastId.replace(/\D/g, ''));
                        if(!isNaN(lastNum)) serial = lastNum + 1;
                    }
                    save(); alert("âœ… å·²å¾é›²ç«¯æˆåŠŸä¸‹è¼‰ " + data.length + " æ¢ç´€éŒ„ï¼");
                }
            } catch(e) { alert("âŒ ä¸‹è¼‰å¤±æ•—ï¼Œè«‹ç¢ºä¿é›²ç«¯å·²æœ‰æ•¸æ“šä¸”è…³æœ¬æ­£ç¢ºéƒ¨ç½²ã€‚"); }
        }

        function render() {
            const search = document.getElementById('stat-search')?.value.toLowerCase() || "";
            const list = document.getElementById('list-container');
            const statList = document.getElementById('stats-list');
            let html = "";
            let filtered = orders.slice().reverse().filter(o => o.id.toLowerCase().includes(search) || o.tel.includes(search) || o.items.some(i => i.name.toLowerCase().includes(search)));

            filtered.forEach(o => {
                const ri = orders.indexOf(o);
                html += `
                <div class="order-card">
                    <div style="display:flex; justify-content:space-between;"><small>#${o.id}</small><b style="color:var(--red)">$${o.totalPrice}</b></div>
                    <strong>ğŸ“ ${o.tel}</strong>
                    ${o.items.map((it, ii) => `<div class="item-box" style="font-size:13px;">${it.name} x${it.qty}<div><span class="tag-btn ${it.bought?'tag-bought':''}" onclick="toggleStatus(${ri},${ii},'bought')">${it.bought?'å·²è²·':'å¾…è²·'}</span><span class="tag-btn ${it.arrived?'tag-arrived':''}" onclick="toggleStatus(${ri},${ii},'arrived')">${it.arrived?'å·²åˆ°æ¸¯':'å¾…åˆ°'}</span></div></div>`).join('')}
                    <div class="status-grid"><div class="st-btn paid ${o.paid?'active':''}" onclick="updStatus(${ri},'paid')">å·²ä»˜</div><div class="st-btn shipped ${o.shipped?'active':''}" onclick="updStatus(${ri},'shipped')">å·²å¯„</div><div class="st-btn refunded ${o.refunded?'active':''}" onclick="updStatus(${ri},'refunded')">é€€æ¬¾</div></div>
                    <button onclick="copyNotice(${ri})" style="background:#5C7CFA; margin:5px 0;">ğŸ“‹ é»æ“Šè¤‡è£½å‡ºå–®é€šçŸ¥</button>
                    <div style="display:flex; gap:5px;">
                        <button onclick="setInfo(${ri},'address','åœ°å€')" style="font-size:11px; background:#EEE; color:#333;">ğŸ  åœ°å€</button>
                        <button onclick="setInfo(${ri},'sfNo','å–®è™Ÿ')" style="font-size:11px; background:#EEE; color:#333;">ğŸ“¦ å–®è™Ÿ</button>
                        <button onclick="delOrder(${ri})" style="font-size:11px; background:#F8D7DA; color:var(--red); width:60px;">åˆªé™¤</button>
                    </div>
                    ${(o.address || o.sfNo) ? `<div class="info-tag">${o.address?`ğŸ“ ${o.address}<br>`:''}${o.sfNo?`ğŸšš SF: ${o.sfNo}`:''}</div>`:''}
                </div>`;
            });
            if(list) list.innerHTML = (search === "") ? html : ""; 
            if(statList) statList.innerHTML = (search !== "") ? html : "";
            updateSummary();
        }

        function toggleStatus(i, ii, k) { orders[i].items[ii][k] = !orders[i].items[ii][k]; save(); }
        function updStatus(i, k) { orders[i][k] = !orders[i][k]; save(); }
        function delOrder(i) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { orders.splice(i,1); save(); } }
        function setInfo(i, k, l) { const v = prompt(`è¼¸å…¥${l}:`, orders[i][k]); if(v!==null) { orders[i][k]=v; save(); } }
        function save() { localStorage.setItem('slow_v62_data', JSON.stringify(orders)); render(); }
        function switchPage(p, btn) { document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); document.querySelectorAll('.page').forEach(el => el.classList.remove('active')); document.getElementById('page-' + p).classList.add('active'); btn.classList.add('active'); if(p === 'buy') renderBuy(); }
        
        function renderBuy() {
            const container = document.getElementById('buy-container');
            let html = "";
            orders.forEach((o, i) => { o.items.forEach((it, ii) => { if(!it.bought || !it.arrived) { 
                html += `<div class="card buy-item"><div class="buy-info"><b>#${o.id}</b> | ${o.tel}<br>${it.name} x${it.qty}</div><div class="buy-action"><button onclick="toggleStatus(${i},${ii},'bought')" style="background:${it.bought?'var(--green)':'var(--yellow)'}; color:${it.bought?'white':'#856404'}; font-size:11px;">${it.bought?'å·²è²·':'å¾…è²·'}</button></div></div>`; 
            } }); });
            container.innerHTML = html || "<p style='text-align:center; color:#999;'>âœ… æ‰€æœ‰æ¡è³¼å·²å®Œæˆ</p>";
        }

        function setFee(f, btn) { currentFee = f; document.querySelectorAll('#page-tools button').forEach(b => { if(b.id.includes('fee')) b.style.background = '#EEE', b.style.color='#666'; }); btn.style.background = 'var(--accent)', btn.style.color='white'; calcEx(); }
        function calcEx() {
            const cur = document.getElementById('cur-sel').value;
            const amt = parseFloat(document.getElementById('ex-in').value) || 0;
            const res = (amt * rates[cur] * currentFee).toFixed(2);
            document.getElementById('ex-res').innerText = amt ? `HKD $${res}` : "";
            if(amt > 0) { const rec = { cur, amt, res, time: new Date().toLocaleTimeString() }; calcHistory.unshift(rec); calcHistory = calcHistory.slice(0, 30); localStorage.setItem('slow_v62_calcs', JSON.stringify(calcHistory)); renderHistory(); }
        }
        function renderHistory() { document.getElementById('calc-history').innerHTML = calcHistory.map(h => `<div class="history-item"><span>${h.amt} ${h.cur}</span><b>$${h.res}</b></div>`).join(''); }
        function updateSummary() { let s = 0, c = 0; orders.forEach(o => { if(!o.refunded) { s += o.totalPrice; o.items.forEach(it => c += (it.qty * it.cost)); } }); const sum = document.getElementById('stats-summary'); if(sum) sum.innerHTML = `<div class="card" style="background:var(--primary); color:white; text-align:center;"><h3>ç¸½ç‡Ÿæ”¶: $${s}</h3><p>é ä¼°åˆ©æ½¤: $${s - c}</p></div>`; }
        function resetSerial() { const v = prompt("æ–°èµ·å§‹ç·¨è™Ÿ:", serial); if(v) { serial = parseInt(v); localStorage.setItem('slow_v62_serial', serial); } }
        function exportJSON() { const data = JSON.stringify(orders); const blob = new Blob([data], {type: 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `SlowOver_Backup.json`; a.click(); }

        window.onload = () => { document.getElementById('order-date').valueAsDate = new Date(); addItemRow(); render(); renderHistory(); };
    </script>
</body>
</html>
