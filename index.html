<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SlowOver CRM V78.0</title>
    <style>
        :root { 
            --primary: #D4A373; --bg: #FAF7F2; --text: #5F4B32; 
            --accent: #8EAD91; --blue: #5C7CFA; --red: #E03131; 
            --green: #40C057; --purple: #7048E8; --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px calc(var(--safe-bottom) + 100px) 15px; }
        
        /* å°è¦½åˆ— */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; padding-bottom: var(--safe-bottom); border-top: 1px solid #EEE; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px 0; text-align: center; font-size: 11px; color: #999; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        
        input, select, button { width: 100%; padding: 12px; margin: 4px 0; border: 1px solid #E0D7CC; border-radius: 10px; font-size: 14px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #CCC !important; cursor: not-allowed; }

        /* è¨‚å–®å¡ç‰‡ */
        .order-card { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; border-left: 8px solid var(--primary); border: 1px solid #EEE; position: relative; }
        .item-box { background: #FCFAf7; padding: 12px; border-radius: 12px; margin: 8px 0; border: 1px solid #F0E6D8; position: relative; }
        
        .del-btn-small { position: absolute; top: 5px; right: 5px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #FFF5F5; border: 1px solid #FFC9C9; border-radius: 6px; color: var(--red); font-size: 12px; }

        .st-btn { font-size: 10px; padding: 10px 0; border-radius: 8px; background: #F8F9FA; color: #BBB; border: 1px solid #EEE; text-align: center; font-weight: bold; }
        .st-btn.active.paid { background: var(--green); color: white; border-color: var(--green); }
        .st-btn.active.arrAll { background: var(--purple); color: white; border-color: var(--purple); }
        .st-btn.active.ship { background: var(--blue); color: white; border-color: var(--blue); }
        .st-btn.active.ref { background: var(--red); color: white; border-color: var(--red); }
        
        .tag { font-size: 10px; padding: 6px 12px; border-radius: 6px; display: inline-block; cursor: pointer; margin-right: 5px; margin-top: 8px; font-weight: bold; border: 1px solid #DDD; background: #FFF; color: #999; }
        .tag.active.buy { background: #FFD43B; color: #856404; border-color: #FFD43B; }
        .tag.active.arr { background: var(--blue); color: white; border-color: var(--blue); }

        .stat-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 5px; align-items: center; padding: 8px 0; border-bottom: 1px solid #F2F2F2; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('main', this)">ğŸ“ è¨‚å–®</div>
        <div class="nav-item" onclick="switchPage('buy', this)">ğŸ›ï¸ æ¡è³¼</div>
        <div class="nav-item" onclick="switchPage('stats', this)">ğŸ“Š çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchPage('tools', this)">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="page-main" class="page active">
        <div class="card">
            <input type="date" id="order-date">
            <input type="tel" id="cust-tel" placeholder="å®¢æˆ¶é›»è©± (WhatsApp)">
            <div id="new-items-container"></div>
            <button onclick="addNewItemField()" style="background:#F1F3F5; color:var(--text); margin-top:10px; border: 1px dashed #CCC;">+ æ–°å¢å•†å“é …ç›®</button>
            <button id="save-btn" onclick="handleSaveAction()" style="height:55px; margin-top:15px; font-size:16px; background:var(--accent); font-weight:bold;">ğŸ’¾ å„²å­˜è¨‚å–®</button>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="page-buy" class="page">
        <div class="card" id="buy-content"></div>
    </div>

    <div id="page-stats" class="page">
        <div class="card">
            <input type="text" id="main-search" placeholder="ğŸ” æœå°‹é›»è©±/å•†å“/å–®è™Ÿ" oninput="renderStats()">
            <div style="display:flex; gap:5px;">
                <input type="date" id="stat-sdate" onchange="renderStats()">
                <input type="date" id="stat-edate" onchange="renderStats()">
            </div>
        </div>
        <div id="stats-summary" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"></div>
        <div id="stats-list"></div>
    </div>

    <div id="page-tools" class="page">
        <div class="card">
            <h3>ğŸ’° åŒ¯ç‡åŠ©æ‰‹</h3>
            <select id="cur-sel" onchange="calcEx()">
                <option value="KRW">éŸ“å¹£ (0.00585)</option>
                <option value="JPY">æ—¥å¹£ (0.0525)</option>
                <option value="THB">æ³°å¹£ (0.222)</option>
            </select>
            <input type="number" id="ex-in" placeholder="è¼¸å…¥å¤–å¹£é‡‘é¡" oninput="calcEx()">
            <div style="display:flex; gap:5px;">
                <button class="fee-btn" onclick="setFee(1.03, this)" style="background:var(--accent)">+3% æ‰¹ç™¼</button>
                <button class="fee-btn" onclick="setFee(1.05, this)" style="background:#EEE; color:#666;">+5% é›¶å”®</button>
            </div>
            <div id="ex-res" style="font-size:28px; text-align:center; color:var(--primary); font-weight:bold; margin:10px 0;">$0.00</div>
            <div id="quote-history" style="max-height:180px; overflow-y:auto; border-top:1px solid #EEE;"></div>
        </div>
        <div class="card">
            <button onclick="syncToCloud()" style="background:var(--blue)">â˜ï¸ åŒæ­¥åˆ°é›²ç«¯</button>
            <button onclick="syncFromCloud()" style="background:var(--accent); margin-top:10px;">â˜ï¸ å¾é›²ç«¯ä¸‹è¼‰</button>
            <p id="sync-time" style="font-size:11px; color:#999; text-align:center; margin-top:8px;">æœ€å¾ŒåŒæ­¥æ™‚é–“ï¼šå°šæœªåŒæ­¥</p>
            <hr>
            <button onclick="resetSerial()" style="background:#666;">ğŸ”¢ é‡è¨­å–®è™Ÿèµ·å§‹</button>
            <button onclick="dangerClearAll()" style="background:none; color:red; margin-top:20px; border:none; font-size:11px; text-decoration: underline;">âš ï¸ æ¸…ç©ºæ‰€æœ‰æ‰‹æ©Ÿè³‡æ–™</button>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒè³‡æ–™åˆå§‹åŒ–
        let orders = [];
        let quotes = [];
        let serial = 300;
        let syncTime = "å°šæœªåŒæ­¥";
        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
        let rates = { KRW: 0.00585, JPY: 0.0525, THB: 0.222 };
        let currentFee = 1.03;

        // éœæ…‹æ–‡å­—
        const PAY_MSG = `ğŸ’¸ä»˜æ¬¾æ–¹å¼ï¼š\nPayMeï¼š\nhttps://qr.payme.hsbc.com.hk/2/Ui316pJ5T8b428yzTSbr4J\n\nFPS:\nå¿«é€Ÿæ”¯ä»˜ç³»çµ±è­˜åˆ¥ç¢¼FPS IDï¼š105249023\nåç¨±ï¼šslow over\n\nâš ï¸ æ³¨æ„äº‹é …ï¼š\n24å°æ™‚å…§å®Œæˆä»˜æ¬¾ä¸¦å›å‚³å…¥æ•¸æˆªåœ–\næˆªåœ–è«‹å‚™è¨»é›»è©±è™Ÿç¢¼ä»¥ä¾¿å°è³¬`;
        const TERMS = `ä¸‹å–®å³åŒæ„ä»¥ä¸‹æ¢æ¬¾ï¼š\n1. 24å°æ™‚å…§å®Œæˆä»˜æ¬¾ä¸¦å›å‚³å…¥æ•¸æˆªåœ–ã€‚\n2. æˆªåœ–è«‹å‚™è¨»æˆ–è¨Šæ¯é›»è©±è™Ÿç¢¼ä»¥ä¾¿å°è³¬ã€‚\n3. è¨‚å–®ä¸€ç¶“ç¢ºèªï¼Œä¸è¨­å–æ¶ˆã€é€€æ›æˆ–æ›´æ”¹ã€‚\n4. å¦‚é‡å•†å“ç¼ºè²¨ï¼Œå°‡æœƒå…¨æ•¸é€€æ¬¾ã€‚\n5. ä¸€èˆ¬é è¨‚éœ€æ™‚ 7-30 å€‹å·¥ä½œå¤©ï¼Œä¸æ¥æ€¥å–®ã€‚\n6. é‹é€éç¨‹å¦‚æœ‰æå£é¢¨éšªéœ€ç”±è²·å®¶æ‰¿æ“”ã€‚\n7. SLOWOVER ä¿ç•™æœ€çµ‚æ±ºå®šæ¬Šã€‚\n\nğŸŒ»ğŸŒ»æ„Ÿè¬æ”¯æŒ SLOWOVERï¼ğŸŒ»ğŸŒ»`;

        // å•Ÿå‹•åŠ è¼‰
        window.onload = function() {
            try {
                orders = JSON.parse(localStorage.getItem('slow_v78_data')) || [];
                quotes = JSON.parse(localStorage.getItem('slow_quotes_v78')) || [];
                serial = parseInt(localStorage.getItem('slow_v78_serial')) || 300;
                syncTime = localStorage.getItem('slow_sync_v78') || "å°šæœªåŒæ­¥";
                
                document.getElementById('order-date').valueAsDate = new Date();
                addNewItemField();
                render();
                console.log("ç³»çµ±åŠ è¼‰æˆåŠŸ");
            } catch (e) {
                console.error("åŠ è¼‰å¤±æ•—ï¼Œæ­£åœ¨é‡ç½®è³‡æ–™", e);
                orders = [];
                save();
            }
        };

        // æ–°å¢å•†å“è¼¸å…¥åˆ—
        function addNewItemField() {
            const container = document.getElementById('new-items-container');
            const div = document.createElement('div');
            div.className = 'item-box new-item-row';
            div.innerHTML = `
                <input type="text" placeholder="å•†å“åç¨±" class="in-name" style="width:80%">
                <div style="display:flex; gap:5px;">
                    <input type="number" value="1" class="in-qty" style="flex:1" placeholder="æ•¸é‡">
                    <input type="number" placeholder="å”®åƒ¹" class="in-price" style="flex:2">
                </div>
                <div class="del-btn-small" onclick="this.parentElement.remove()">âœ•</div>
            `;
            container.appendChild(div);
        }

        // å„²å­˜é‚è¼¯
        function handleSaveAction() {
            const btn = document.getElementById('save-btn');
            const tel = document.getElementById('cust-tel').value.trim();
            const date = document.getElementById('order-date').value;
            const itemRows = document.querySelectorAll('.new-item-row');

            // 1. é©—è­‰
            if (!tel) return alert("âŒ è«‹è¼¸å…¥å®¢æˆ¶é›»è©±");
            if (itemRows.length === 0) return alert("âŒ è«‹è‡³å°‘æ–°å¢ä¸€å€‹å•†å“");

            let newItems = [];
            let totalP = 0;

            itemRows.forEach(row => {
                const name = row.querySelector('.in-name').value.trim();
                const qty = parseInt(row.querySelector('.in-qty').value) || 0;
                const price = parseFloat(row.querySelector('.in-price').value) || 0;
                
                if (name !== "") {
                    newItems.push({
                        name: name,
                        qty: qty,
                        price: price,
                        cost: 0,
                        bought: false,
                        arrived: false
                    });
                    totalP += (qty * price);
                }
            });

            if (newItems.length === 0) return alert("âŒ è«‹å¡«å¯«å•†å“åç¨±");

            // 2. åŸ·è¡Œå„²å­˜
            try {
                const orderID = `WS${new Date().getFullYear().toString().slice(-2)}${MONTHS[new Date().getMonth()]}${serial}`;
                const newOrder = {
                    id: orderID,
                    date: date,
                    tel: tel,
                    items: newItems,
                    totalPrice: totalP,
                    totalCost: 0,
                    paid: false,
                    shipped: false,
                    refunded: false,
                    address: "",
                    sfNo: ""
                };

                orders.push(newOrder);
                serial++;
                save();
                
                // 3. æˆåŠŸå¾Œé‡ç½®ä»‹é¢
                document.getElementById('cust-tel').value = "";
                document.getElementById('new-items-container').innerHTML = "";
                addNewItemField();
                render();

                // 4. å†·å»æŒ‰éˆ•
                startCooldown(btn);
            } catch (err) {
                alert("ğŸ†˜ å„²å­˜ç™¼ç”ŸéŒ¯èª¤: " + err.message);
            }
        }

        function startCooldown(btn) {
            btn.disabled = true;
            let sec = 5;
            const timer = setInterval(() => {
                btn.innerText = `âœ… å„²å­˜æˆåŠŸ (${sec}s)`;
                sec--;
                if (sec < 0) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.innerText = "ğŸ’¾ å„²å­˜è¨‚å–®";
                }
            }, 1000);
        }

        function save() {
            localStorage.setItem('slow_v78_data', JSON.stringify(orders));
            localStorage.setItem('slow_v78_serial', serial.toString());
        }

        // æ¸²æŸ“ä¸»æ¸…å–®
        function render() {
            const container = document.getElementById('list-container');
            if (orders.length === 0) {
                container.innerHTML = "<center style='padding:40px; color:#CCC;'>å°šç„¡è¨‚å–®</center>";
                return;
            }

            container.innerHTML = orders.slice().reverse().map(o => {
                const idx = orders.indexOf(o);
                const allArr = o.items.length > 0 && o.items.every(i => i.arrived);
                return `
                    <div class="order-card">
                        <div style="display:flex; justify-content:space-between;">
                            <small>#${o.id}</small>
                            <b style="color:var(--red)">$${o.totalPrice}</b>
                        </div>
                        <div style="margin:5px 0;"><strong>ğŸ“ ${o.tel}</strong></div>
                        
                        ${o.items.map((it, ii) => `
                            <div class="item-box">
                                <div style="display:flex; justify-content:space-between; font-size:13px;">
                                    <span>${it.name} x${it.qty}</span>
                                    <b>$${it.price}</b>
                                </div>
                                <div class="tag buy ${it.bought?'active':''}" onclick="toggleTag(${idx}, ${ii}, 'bought')">
                                    ${it.bought?'å·²è²·':'æœªè²·'}
                                </div>
                                <div class="tag arr ${it.arrived?'active':''}" onclick="toggleTag(${idx}, ${ii}, 'arrived')">
                                    ${it.arrived?'å·²åˆ°æ¸¯':'æœªåˆ°'}
                                </div>
                            </div>
                        `).join('')}

                        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:4px; margin:10px 0;">
                            <div class="st-btn paid ${o.paid?'active':''}" onclick="updateStatus(${idx}, 'paid')">å·²ä»˜æ¬¾</div>
                            <div class="st-btn arrAll ${allArr?'active':''}">å…¨åˆ°æ¸¯</div>
                            <div class="st-btn ship ${o.shipped?'active':''}" onclick="updateStatus(${idx}, 'shipped')">å·²å¯„å‡º</div>
                            <div class="st-btn ref ${o.refunded?'active':''}" onclick="updateStatus(${idx}, 'refunded')">å·²é€€æ¬¾</div>
                        </div>

                        <input type="text" placeholder="æ”¶ä»¶è³‡æ–™" value="${o.address}" onchange="updateInfo(${idx}, 'address', this.value)">
                        <input type="text" placeholder="é‹å–®è™Ÿç¢¼" value="${o.sfNo}" onchange="updateInfo(${idx}, 'sfNo', this.value)">

                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <button onclick="copyBill(${idx})" style="font-size:11px; flex:1; background:var(--accent);">ğŸ“‹ è¤‡è£½é€šçŸ¥</button>
                            <button onclick="copyInfoReq(${idx})" style="font-size:11px; flex:1; background:var(--purple);">ğŸ“‹ ç´¢å–è³‡æ–™</button>
                        </div>
                        <button onclick="deleteOrder(${idx})" style="background:none; color:red; font-size:10px; border:none; margin-top:10px; width:auto; text-decoration:underline;">å…¨å–®åˆªé™¤</button>
                    </div>
                `;
            }).join('');
        }

        // ç‹€æ…‹æ›´æ–°
        function toggleTag(oIdx, iIdx, key) {
            orders[oIdx].items[iIdx][key] = !orders[oIdx].items[iIdx][key];
            save(); render();
        }
        function updateStatus(oIdx, key) {
            orders[oIdx][key] = !orders[oIdx][key];
            save(); render();
        }
        function updateInfo(oIdx, key, val) {
            orders[oIdx][key] = val;
            save(); render();
        }
        function deleteOrder(idx) {
            if (confirm("ç¢ºå®šåˆªé™¤é€™å¼µè¨‚å–®å—ï¼Ÿ")) {
                orders.splice(idx, 1);
                save(); render();
            }
        }

        // çµ±è¨ˆé‚è¼¯
        function renderStats() {
            const search = document.getElementById('main-search').value.toLowerCase();
            const sDate = document.getElementById('stat-sdate').value;
            const eDate = document.getElementById('stat-edate').value;

            let filtered = orders.filter(o => {
                const matchKey = o.tel.includes(search) || o.id.toLowerCase().includes(search) || o.items.some(i => i.name.toLowerCase().includes(search));
                const matchDate = (!sDate || o.date >= sDate) && (!eDate || o.date <= eDate);
                return matchKey && matchDate;
            });

            let tRev = 0, tCost = 0;
            const listHtml = filtered.map(o => {
                const oIdx = orders.indexOf(o);
                const stat = getAutoLabel(o);
                if (!o.refunded) {
                    tRev += o.totalPrice;
                    tCost += o.totalCost;
                }
                return `
                    <div class="card" style="border-left:5px solid ${stat.color}; font-size:12px;">
                        <div style="display:flex; justify-content:space-between;">
                            <b>#${o.id}</b> <span style="color:${stat.color}">${stat.text}</span>
                        </div>
                        <div style="margin:8px 0; background:#FAFAFA; padding:8px; border-radius:8px;">
                            ${o.items.map((it, ii) => `
                                <div class="stat-row">
                                    <span>${it.name}</span>
                                    <span style="text-align:center;">$${it.price}</span>
                                    <input type="number" value="${it.cost}" onchange="updateCost(${oIdx}, ${ii}, this.value)" style="padding:4px; height:25px; margin:0; text-align:center;">
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align:right;">åˆ©æ½¤: <b>$${(o.totalPrice - o.totalCost).toFixed(1)}</b></div>
                    </div>
                `;
            }).join('');

            document.getElementById('stats-summary').innerHTML = `
                <div style="background:var(--primary); color:white; padding:10px; border-radius:10px; text-align:center;">ç‡Ÿæ¥­é¡<br><b>$${tRev.toFixed(1)}</b></div>
                <div style="background:var(--accent); color:white; padding:10px; border-radius:10px; text-align:center;">æ·¨åˆ©æ½¤<br><b>$${(tRev - tCost).toFixed(1)}</b></div>
            `;
            document.getElementById('stats-list').innerHTML = listHtml;
        }

        function getAutoLabel(o) {
            if (o.refunded) return { text: "å·²é€€æ¬¾", color: "red" };
            if (o.address || o.sfNo) return { text: "å·²ä»˜å‡º", color: "var(--blue)" };
            const allArr = o.items.every(i => i.arrived);
            const allBuy = o.items.every(i => i.bought);
            if (allArr) return { text: "å…¨éƒ¨å·²åˆ°æ¸¯ï¼Œæœªå¯„å‡º", color: "var(--purple)" };
            if (allBuy) return { text: "å·²è²·é½Šï¼Œæœªåˆ°æ¸¯", color: "orange" };
            return { text: "æ¡è³¼ä¸­", color: "#999" };
        }

        function updateCost(oIdx, iIdx, val) {
            orders[oIdx].items[iIdx].cost = parseFloat(val) || 0;
            let subCost = 0;
            orders[oIdx].items.forEach(it => subCost += (it.cost * it.qty));
            orders[oIdx].totalCost = subCost;
            save(); renderStats();
        }

        // æ¡è³¼é‚è¼¯
        function renderBuy() {
            let map = {};
            orders.forEach(o => {
                o.items.forEach(it => {
                    if (!map[it.name]) map[it.name] = { total: 0, bought: 0 };
                    map[it.name].total += it.qty;
                    if (it.bought) map[it.name].bought += it.qty;
                });
            });
            let undone = "", done = "";
            for (let k in map) {
                const item = map[k];
                const html = `<div style="padding:10px 0; border-bottom:1px solid #EEE;">
                    <b>${k}</b><br>
                    <small>å·²è²·: <span style="color:green">${item.bought}</span> / ç¸½éœ€: ${item.total} | ç¼º: <span style="color:red">${item.total - item.bought}</span></small>
                </div>`;
                if (item.bought < item.total) undone += html; else done += html;
            }
            document.getElementById('buy-content').innerHTML = `
                <h4 style="margin:0 0 10px 0; color:var(--red);">æœªè²·é½Š</h4>${undone || 'ç„¡'}
                <h4 style="margin:20px 0 10px 0; color:var(--green);">å·²è²·é½Š</h4>${done || 'ç„¡'}
            `;
        }

        // å…¶ä»–åŠŸèƒ½
        function copyBill(idx) {
            const o = orders[idx];
            const itemList = o.items.map(i => `- ${i.name} x ${i.qty}`).join('\n');
            const msg = `ã€SlowOver å‡ºå–®é€šçŸ¥ã€‘\nå–®è™Ÿï¼š#${o.id}\næ—¥æœŸï¼š${o.date}\né›»è©±ï¼š${o.tel}\n\nè¨‚è³¼é …ç›®ï¼š\n${itemList}\nç¸½è¨ˆé‡‘é¡ï¼šHKD $${o.totalPrice}\n\n${PAY_MSG}\n\n${TERMS}`;
            navigator.clipboard.writeText(msg).then(() => alert("å·²è¤‡è£½é€šçŸ¥å…§å®¹"));
        }

        function copyInfoReq(idx) {
            const msg = `ã€SlowOver ç´¢å–æ”¶è²¨è³‡æ–™ã€‘\nå–®è™Ÿï¼š#${orders[idx].id}\nè¨‚å–®å·²åˆ°é½Šï¼Œè«‹æä¾›ï¼š\n1. æ”¶ä»¶å§“åï¼š\n2. è¯çµ¡é›»è©±ï¼š\n3. é †è±ç¢¼æˆ–åœ°å€ï¼š\n\næ„Ÿè¬ï¼ğŸŒ»`;
            navigator.clipboard.writeText(msg).then(() => alert("å·²è¤‡è£½æ¨¡æ¿"));
        }

        function calcEx() {
            const amt = document.getElementById('ex-in').value;
            const cur = document.getElementById('cur-sel').value;
            if(!amt) return;
            const res = (amt * rates[cur] * currentFee).toFixed(2);
            document.getElementById('ex-res').innerText = `$${res}`;
            quotes.unshift({ t: new Date().toLocaleTimeString(), a: amt, c: cur, f: currentFee, r: res });
            if (quotes.length > 30) quotes.pop();
            localStorage.setItem('slow_quotes_v78', JSON.stringify(quotes));
            renderQuotes();
        }

        function renderQuotes() {
            document.getElementById('quote-history').innerHTML = quotes.map(q => `
                <div style="font-size:11px; padding:5px 0; border-bottom:1px solid #EEE;">
                    ${q.t} | ${q.a}${q.c} (${q.f==1.03?'+3%':'+5%'}) â” <b>$${q.r}</b>
                </div>
            `).join('');
        }

        function setFee(f, btn) {
            currentFee = f;
            document.querySelectorAll('.fee-btn').forEach(b => b.style.background = "#EEE");
            btn.style.background = "var(--accent)";
            calcEx();
        }

        function switchPage(p, btn) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            btn.classList.add('active');
            if(p === 'buy') renderBuy();
            if(p === 'stats') renderStats();
        }

        function dangerClearAll() {
            if(confirm("ğŸš¨ é€™å°‡æ¸…ç©ºæ‰‹æ©Ÿå…§æ‰€æœ‰ SlowOver çš„è¨‚å–®ï¼\nç¢ºå®šå—ï¼Ÿ")) {
                localStorage.clear();
                location.reload();
            }
        }

        function resetSerial() {
            const v = prompt("è¨­å®šæ–°çš„èµ·å§‹å–®è™Ÿ (ç›®å‰æ˜¯ " + serial + "):", serial);
            if(v) { serial = parseInt(v); save(); alert("å·²é‡è¨­"); }
        }
    </script>
</body>
</html>
