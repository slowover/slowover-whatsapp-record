<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SlowOver CRM V88.0</title>
    <style>
        :root { 
            --primary: #D4A373; --bg: #FAF7F2; --text: #5F4B32; 
            --accent: #8EAD91; --blue: #5C7CFA; --red: #E03131; 
            --green: #40C057; --purple: #7048E8; --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px calc(var(--safe-bottom) + 100px) 15px; }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; padding-bottom: var(--safe-bottom); border-top: 1px solid #EEE; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px 0; text-align: center; font-size: 11px; color: #999; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        input, select, button { width: 100%; padding: 12px; margin: 4px 0; border: 1px solid #E0D7CC; border-radius: 10px; font-size: 14px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { opacity: 0.6; }
        .order-card { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #EEE; border-left: 8px solid var(--primary); }
        .item-box { background: #FCFAf7; padding: 12px; border-radius: 12px; margin: 8px 0; border: 1px solid #F0E6D8; position: relative; }
        .st-btn { font-size: 10px; padding: 10px 0; border-radius: 8px; background: #F8F9FA; color: #BBB; border: 1px solid #EEE; text-align: center; font-weight: bold; cursor: pointer; }
        .st-btn.active.paid { background: var(--green); color: white; border-color: var(--green); }
        .st-btn.active.ship { background: var(--blue); color: white; border-color: var(--blue); }
        .tag { font-size: 10px; padding: 6px 12px; border-radius: 6px; display: inline-block; cursor: pointer; margin-right: 5px; margin-top: 8px; font-weight: bold; border: 1px solid #DDD; background: #FFF; color: #999; }
        .tag.active.buy { background: #FFD43B; color: #856404; border-color: #FFD43B; }
        .tag.active.arr { background: var(--blue); color: white; border-color: var(--blue); }
        #sync-status { position: fixed; top: 15px; right: 15px; font-size: 10px; background: var(--text); color: white; padding: 5px 12px; border-radius: 20px; display: none; z-index: 2000; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        #ex-history { max-height: 180px; overflow-y: auto; background: #FCFAf7; border-radius: 10px; padding: 8px; margin-top: 5px; border: 1px solid #EEE; }
        #ex-history div { font-size: 11px; padding: 6px 0; border-bottom: 1px solid #EEE; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="sync-status">â˜ï¸ åŒæ­¥ä¸­...</div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('main', this)">ğŸ“ è¨‚å–®</div>
        <div class="nav-item" onclick="switchPage('buy', this)">ğŸ›ï¸ æ¡è³¼</div>
        <div class="nav-item" onclick="switchPage('stats', this)">ğŸ“Š çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchPage('tools', this)">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="page-main" class="page active">
        <div class="card">
            <h3 style="margin:0;">ğŸ“ æ–°å¢è¨‚å–®</h3>
            <input type="date" id="order-date">
            <input type="tel" id="cust-tel" placeholder="å®¢æˆ¶é›»è©± (WhatsApp)">
            <div id="new-items-container"></div>
            <button onclick="addNewItemField()" style="background:#F1F3F5; color:var(--text); border:1px dashed #CCC; margin-top:10px;">+ æ–°å¢å•†å“é …ç›®</button>
            <button onclick="handleSaveAction()" style="height:55px; margin-top:15px; background:var(--accent); font-size:16px;">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥é›²ç«¯</button>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="page-buy" class="page">
        <div class="card" id="buy-content"></div>
    </div>

    <div id="page-stats" class="page">
        <div id="stats-summary" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px;"></div>
        <div id="stats-list"></div>
    </div>

    <div id="page-tools" class="page">
        <div class="card">
            <h3>â˜ï¸ é›²ç«¯åŒæ­¥ç‹€æ…‹</h3>
            <p id="last-sync-time" style="font-size:12px; color:#999;">æœ€å¾Œæ›´æ–°ï¼šæ­£åœ¨è®€å–...</p>
            <button onclick="syncFromCloud()" style="background:var(--blue);">ğŸ”„ å¼·åˆ¶é‡æ–°æ•´ç†è³‡æ–™</button>
        </div>

        <div class="card">
            <h3>ğŸ’° åŒ¯ç‡åŠ©æ‰‹</h3>
            <div style="display:flex; gap:5px; margin-bottom:8px;">
                <select id="cur-sel" onchange="calcEx()" style="flex:1">
                    <option value="KRW">éŸ“å¹£ (0.00585)</option>
                    <option value="JPY">æ—¥å¹£ (0.0525)</option>
                    <option value="THB">æ³°å¹£ (0.222)</option>
                </select>
                <div style="flex:1; display:flex; align-items:center; background:#F8F9FA; border:1px solid #E0D7CC; border-radius:10px; padding:0 10px;">
                    <input type="number" id="fee-custom" value="3" oninput="calcEx()" style="border:none; background:transparent; width:45px; text-align:center; font-weight:bold;"><span>%</span>
                </div>
            </div>
            <input type="number" id="ex-in" placeholder="è¼¸å…¥å¤–å¹£é‡‘é¡" oninput="calcEx()">
            <button onclick="saveExHistory()" style="background:var(--accent); margin-top:5px; font-size:13px;">ğŸ“Œ ç´€éŒ„æ›ç®—çµæœ</button>
            <div id="ex-res" style="font-size:35px; text-align:center; color:var(--primary); font-weight:bold; margin:15px 0;">$0.00</div>
            <div style="display:flex; justify-content:space-between; align-items:center;"><small>ğŸ•’ æœ€è¿‘ 30 ç­†ç´€éŒ„</small><small onclick="clearExHistory()" style="color:red;">æ¸…ç©º</small></div>
            <div id="ex-history"></div>
        </div>

        <div class="card">
            <h3>ğŸ”¢ å–®è™Ÿä¿®æ­£</h3>
            <div style="display:flex; gap:5px; align-items:center;">
                <input type="number" id="next-serial" style="width:120px; margin:0;">
                <button onclick="updateSerial()" style="background:#666;">ä¿®æ­£</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxPku0qTD-XQvctzBYfHQNflwBn0QH-WjwTzPwfWMDsyMvym94i0f-MlXtUbHpEjJZaRA/exec";
        
        const PAY_MSG = `ğŸ’¸ä»˜æ¬¾æ–¹å¼ï¼š\nPayMeï¼š\nhttps://qr.payme.hsbc.com.hk/2/Ui316pJ5T8b428yzTSbr4J\n\nå¿«é€Ÿæ”¯ä»˜ç³»çµ±è­˜åˆ¥ç¢¼FPS IDï¼š105249023\nåç¨±ï¼šslow over\n\nâš ï¸ æ³¨æ„äº‹é …ï¼š\n24å°æ™‚å…§å®Œæˆä»˜æ¬¾ä¸¦å›å‚³æˆªåœ–\næˆªåœ–è«‹å‚™è¨»é›»è©±è™Ÿç¢¼`;
        const TERMS = `ä¸‹å–®æ¢æ¬¾ï¼š\n1. 24å°æ™‚å…§ä»˜æ¬¾ã€‚\n2. ç¢ºèªå¾Œä¸è¨­å–æ¶ˆ/é€€æ›ã€‚\n3. ç¼ºè²¨å…¨é€€ã€‚\n4. é è¨‚ 7-30 å·¥ä½œå¤©ã€‚\n5. SLOWOVER ä¿ç•™æ±ºå®šæ¬Šã€‚`;

        let orders = [];
        let serial = 300;
        let exHistory = JSON.parse(localStorage.getItem('slow_ex_v88')) || [];

        window.onload = async () => {
            document.getElementById('order-date').valueAsDate = new Date();
            addNewItemField();
            await syncFromCloud();
            renderExHistory();
        };

        // --- åŒæ­¥é‚è¼¯ ---
async function autoPush() {
    const status = document.getElementById('sync-status');
    status.style.display = 'block';
    
    try {
        await fetch(GAS_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify({ 
                orders: orders, 
                nextSerial: serial 
            })
        });
        document.getElementById('last-sync-time').innerText = "æœ€å¾ŒåŒæ­¥ï¼š" + new Date().toLocaleTimeString();
    } catch (e) {
        console.error("åŒæ­¥å¤±æ•—", e);
    }
    setTimeout(() => { status.style.display = 'none'; }, 800);
}

        // --- åŒ¯ç‡é‚è¼¯ ---
        function calcEx() {
            const amt = document.getElementById('ex-in').value;
            const rate = { KRW: 0.00585, JPY: 0.0525, THB: 0.222 }[document.getElementById('cur-sel').value];
            const fee = 1 + (parseFloat(document.getElementById('fee-custom').value || 0) / 100);
            document.getElementById('ex-res').innerText = amt > 0 ? `$${(amt * rate * fee).toFixed(2)}` : "$0.00";
        }
        function saveExHistory() {
            const res = document.getElementById('ex-res').innerText;
            if (res === "$0.00") return;
            const cur = document.getElementById('cur-sel').value;
            const h = `<div><span>[${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}] ${cur} (+${document.getElementById('fee-custom').value}%)</span><b>${res}</b></div>`;
            exHistory.unshift(h); if (exHistory.length > 30) exHistory.pop();
            localStorage.setItem('slow_ex_v88', JSON.stringify(exHistory)); renderExHistory();
        }
        function renderExHistory() { document.getElementById('ex-history').innerHTML = exHistory.join(''); }
        function clearExHistory() { exHistory = []; localStorage.removeItem('slow_ex_v88'); renderExHistory(); }

        // --- è¨‚å–®é‚è¼¯ ---
        function handleSaveAction() {
            const tel = document.getElementById('cust-tel').value.trim();
            const date = document.getElementById('order-date').value;
            const rows = document.querySelectorAll('.new-item-row');
            if(!tel || rows.length === 0) return alert("è«‹å¡«è³‡æ–™");
            let its = []; let tp = 0;
            rows.forEach(r => {
                const n = r.querySelector('.in-name').value;
                const q = parseInt(r.querySelector('.in-qty').value) || 1;
                const p = parseFloat(r.querySelector('.in-price').value) || 0;
                if(n) { its.push({name:n, qty:q, price:p, cost:0, bought:false, arrived:false}); tp += (q*p); }
            });
            const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const id = `WS${new Date().getFullYear().toString().slice(-2)}${months[new Date().getMonth()]}${serial}`;
            orders.push({id, date, tel, items:its, totalPrice:tp, totalCost:0, paid:false, shipped:false, address:""});
            serial++; render(); autoPush();
            document.getElementById('cust-tel').value = ""; document.getElementById('new-items-container').innerHTML = ""; addNewItemField();
            document.getElementById('next-serial').value = serial;
        }

        function toggleTag(oi, ii, k) { orders[oi].items[ii][k] = !orders[oi].items[ii][k]; render(); autoPush(); }
        function updStat(oi, k) { orders[oi][k] = !orders[oi][k]; render(); autoPush(); }
        function updInfo(oi, k, v) { orders[oi][k] = v; autoPush(); }
        function updCost(oi, ii, v) { 
            orders[oi].items[ii].cost = parseFloat(v) || 0; 
            let sub = 0; orders[oi].items.forEach(i => sub += (i.cost * i.qty)); 
            orders[oi].totalCost = sub; renderStats(); autoPush(); 
        }

        function render() {
            const list = document.getElementById('list-container');
            list.innerHTML = orders.slice().reverse().map((o, i) => {
                const rIdx = orders.length - 1 - i;
                const allArr = o.items.length > 0 && o.items.every(it => it.arrived);
                return `<div class="order-card">
                    <div style="display:flex; justify-content:space-between;"><small>#${o.id}</small><b>$${o.totalPrice}</b></div>
                    <strong>ğŸ“ ${o.tel}</strong>
                    ${o.items.map((it, ii) => `
                        <div class="item-box">
                            <div style="font-size:13px; display:flex; justify-content:space-between;"><span>${it.name} x${it.qty}</span></div>
                            <div class="tag buy ${it.bought?'active':''}" onclick="toggleTag(${rIdx}, ${ii}, 'bought')">${it.bought?'å·²è²·':'æœªè²·'}</div>
                            <div class="tag arr ${it.arrived?'active':''}" onclick="toggleTag(${rIdx}, ${ii}, 'arrived')">${it.arrived?'åˆ°æ¸¯':'æœªåˆ°'}</div>
                        </div>`).join('')}
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:4px; margin-top:10px;">
                        <div class="st-btn paid ${o.paid?'active':''}" onclick="updStat(${rIdx},'paid')">ä»˜</div>
                        <div class="st-btn" style="background:${allArr?'var(--purple)':'#F8F9FA'}; color:${allArr?'white':'#BBB'}">é½Š</div>
                        <div class="st-btn ship ${o.shipped?'active':''}" onclick="updStat(${rIdx},'shipped')">å¯„</div>
                        <div class="st-btn" onclick="if(confirm('åˆªé™¤ï¼Ÿ')){orders.splice(${rIdx},1);render();autoPush();}" style="color:red">ğŸ—‘ï¸</div>
                    </div>
                    <input type="text" placeholder="åœ°å€/é‹å–®è™Ÿ" value="${o.address||''}" onchange="updInfo(${rIdx},'address',this.value)" style="font-size:11px; margin-top:10px; padding:8px;">
                    <div style="display:flex; gap:5px; margin-top:8px;">
                        <button onclick="copyMsg(${rIdx}, 'bill')" style="font-size:11px; flex:1; background:var(--accent);">ğŸ“‹ é€šçŸ¥</button>
                        <button onclick="copyMsg(${rIdx}, 'req')" style="font-size:11px; flex:1; background:var(--purple);">ğŸ“‹ ç´¢è³‡</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderStats() {
            let tr = 0, tc = 0;
            const h = orders.map((o, oi) => {
                tr += o.totalPrice; tc += (o.totalCost || 0);
                return `<div class="card" style="font-size:12px;"><b>#${o.id}</b> | ${o.tel}
                    ${o.items.map((it, ii) => `<div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:5px; margin:5px 0;"><span>${it.name}</span><span>$${it.price}</span><input type="number" value="${it.cost}" onchange="updCost(${oi},${ii},this.value)" placeholder="æˆæœ¬" style="height:25px; padding:2px;"></div>`).join('')}
                    <div style="text-align:right; font-weight:bold; color:var(--primary);">åˆ©æ½¤: $${(o.totalPrice - (o.totalCost||0)).toFixed(1)}</div>
                </div>`;
            }).join('');
            document.getElementById('stats-summary').innerHTML = `<div style="background:var(--primary);color:white;padding:10px;border-radius:10px;text-align:center;">ç‡Ÿæ¥­é¡<br><b>$${tr}</b></div><div style="background:var(--accent);color:white;padding:10px;border-radius:10px;text-align:center;">ç¸½åˆ©æ½¤<br><b>$${(tr-tc).toFixed(1)}</b></div>`;
            document.getElementById('stats-list').innerHTML = h;
        }

        function renderBuy() {
            let map = {}; orders.forEach(o => o.items.forEach(it => {
                if (!map[it.name]) map[it.name] = { t: 0, b: 0 };
                map[it.name].t += it.qty; if (it.bought) map[it.name].b += it.qty;
            }));
            let undone = "";
            for (let k in map) if (map[k].b < map[k].t) undone += `<div style="padding:10px 0; border-bottom:1px solid #EEE;"><b>${k}</b><br><small>æ¬ : <span style="color:red">${map[k].t - map[k].b}</span> / ç¸½: ${map[k].t}</small></div>`;
            document.getElementById('buy-content').innerHTML = `<h3>ğŸ›ï¸ æ¬ è²¨æ¸…å–®</h3>${undone || 'âœ… è²¨å…¨é½Šäº†ï¼'}`;
        }

        function addNewItemField() {
            const div = document.createElement('div'); div.className = 'item-box new-item-row';
            div.innerHTML = `<input type="text" placeholder="å•†å“åç¨±" class="in-name" style="width:80%"><div style="display:flex; gap:5px;"><input type="number" value="1" class="in-qty" style="flex:1"><input type="number" placeholder="å”®åƒ¹" class="in-price" style="flex:2"></div>`;
            document.getElementById('new-items-container').appendChild(div);
        }

        function switchPage(p, btn) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active'); btn.classList.add('active');
            if(p === 'buy') renderBuy(); if(p === 'stats') renderStats();
        }

        function copyMsg(idx, type) {
            const o = orders[idx];
            let txt = type === 'bill' ? `ã€SlowOver å‡ºå–®é€šçŸ¥ã€‘\nå–®è™Ÿï¼š#${o.id}\né›»è©±ï¼š${o.tel}\n\né …ç›®ï¼š\n${o.items.map(i=>`- ${i.name} x ${i.qty}`).join('\n')}\nç¸½è¨ˆï¼šHKD $${o.totalPrice}\n\n${PAY_MSG}\n\n${TERMS}` : `ã€SlowOver ç´¢å–è³‡æ–™ã€‘\nå–®è™Ÿï¼š#${o.id}\nè²¨å·²é½Šå‚™ï¼Œè«‹æä¾›æ”¶ä»¶è³‡æ–™ã€‚ğŸŒ»`;
            navigator.clipboard.writeText(txt).then(() => alert("âœ… å·²è¤‡è£½"));
        }
        function updateSerial() { serial = parseInt(document.getElementById('next-serial').value); autoPush(); alert("âœ… å–®è™Ÿå·²ä¿®æ­£"); }
    </script>
</body>
</html>
