<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SlowOver">
    <link rel="apple-touch-icon" href="https://img.icons8.com/clouds/512/shopping-bag.png">
    <title>SlowOver CRM V61.0</title>
    <style>
        :root { 
            --primary: #D4A373; --bg: #FAF7F2; --text: #5F4B32; 
            --accent: #8EAD91; --blue: #5C7CFA; --red: #E03131; 
            --green: #40C057; --gray: #999; --yellow: #FFD43B;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { -webkit-user-select: none; -webkit-touch-callout: none; -webkit-tap-highlight-color: transparent; }
        input, textarea { -webkit-user-select: text !important; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 20px 15px calc(var(--safe-bottom) + 100px) 15px; }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); display: flex; padding-bottom: var(--safe-bottom); border-top: 1px solid #EEE; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px 0; text-align: center; font-size: 11px; color: var(--gray); font-weight: bold; }
        .nav-item.active { color: var(--primary); }

        .card { background: white; padding: 18px; border-radius: 22px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        
        input, select, button { width: 100%; padding: 14px; margin: 5px 0; border: 1px solid #E0D7CC; border-radius: 12px; font-size: 15px; outline: none; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; }
        
        .order-card { background: white; padding: 18px; border-radius: 25px; margin-bottom: 15px; border-left: 8px solid var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .item-box { background: #FCFAf7; padding: 12px; border-radius: 15px; margin: 8px 0; border: 1px solid #F0E6D8; }
        
        /* ç‹€æ…‹æŒ‰éˆ•é¡è‰²ç³»çµ± */
        .status-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin: 10px 0; }
        .st-btn { font-size: 10px; padding: 8px 0; border-radius: 10px; background: #F8F9FA; color: #BBB; border: 1px solid #EEE; text-align: center; }
        .st-btn.active.paid { background: var(--green); color: white; }
        .st-btn.active.shipped { background: var(--blue); color: white; }
        .st-btn.active.refunded { background: var(--red); color: white; }
        
        .tag-btn { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 10px; margin-left: 5px; }
        .tag-bought { background: var(--yellow); color: #856404; }
        .tag-arrived { background: #E7F5FF; color: var(--blue); }
        
        .info-tag { font-size: 11px; background: #F8F9FA; padding: 10px; border-radius: 12px; margin-top: 8px; line-height: 1.5; border: 1px dashed #DDD; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('main', this)">ğŸ“ è¨‚å–®</div>
        <div class="nav-item" onclick="switchPage('buy', this)">ğŸ›ï¸ æ¡è³¼</div>
        <div class="nav-item" onclick="switchPage('stats', this)">ğŸ“Š çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchPage('tools', this)">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="page-main" class="page active">
        <h2>æ–°è¨‚å–®</h2>
        <div class="card">
            <input type="date" id="order-date">
            <input type="tel" id="cust-tel" placeholder="å®¢æˆ¶é›»è©± (å¿…å¡«)">
            <div id="items-area"></div>
            <button onclick="addItemRow()" style="background:#F1F3F5; color:var(--text);">+ æ–°å¢å•†å“é …ç›®</button>
            <button onclick="saveOrder()" style="height:55px; margin-top:10px;">ğŸ’¾ å„²å­˜ä¸¦ç™¼é€é€šçŸ¥</button>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="page-buy" class="page">
        <h2>ğŸ›ï¸ æ¡è³¼èˆ‡åˆ°æ¸¯æ¸…å–®</h2>
        <div id="buy-container"></div>
    </div>

    <div id="page-stats" class="page">
        <h2>ğŸ“Š ç‡Ÿé‹çµ±è¨ˆ</h2>
        <div id="stats-summary"></div>
        <div id="stats-list"></div>
    </div>

    <div id="page-tools" class="page">
        <h2>âš™ï¸ ç³»çµ±è¨­å®š</h2>
        <div class="card">
            <h3>ğŸ’° åŒ¯ç‡åŠ©æ‰‹</h3>
            <select id="cur-sel" onchange="calcEx()">
                <option value="KRW">éŸ“å¹£ (0.00585)</option>
                <option value="JPY">æ—¥å¹£ (0.0525)</option>
                <option value="THB">æ³°å¹£ (0.222)</option>
            </select>
            <input type="number" id="ex-in" placeholder="è¼¸å…¥å¤–å¹£é‡‘é¡" oninput="calcEx()">
            <div id="ex-res" style="font-weight:bold; color:var(--primary); margin-top:10px;"></div>
        </div>
        <div class="card">
            <button onclick="resetSerial()">ğŸ”¢ é‡è¨­èµ·å§‹æµæ°´è™Ÿ</button>
            <button onclick="exportJSON()" style="background:var(--blue); margin-top:10px;">å‚™ä»½æ•¸æ“š (JSON)</button>
        </div>
    </div>

    <script>
        const GAS_URL = "ä½ çš„_GOOGLE_SCRIPT_ç¶²å€";
        let orders = JSON.parse(localStorage.getItem('slow_v61_data') || '[]');
        let serial = parseInt(localStorage.getItem('slow_v61_serial') || '300');
        let rates = { KRW: 0.00585, JPY: 0.0525, THB: 0.222 };

        function addItemRow() {
            const div = document.createElement('div');
            div.className = 'item-box';
            div.innerHTML = `
                <input type="text" placeholder="å•†å“åç¨±" class="in-n">
                <div style="display:flex; gap:5px;">
                    <input type="number" value="1" class="in-q" style="flex:1">
                    <input type="number" placeholder="å”®åƒ¹" class="in-p" style="flex:2">
                    <input type="number" placeholder="æˆæœ¬" class="in-c" style="flex:2">
                </div>
            `;
            document.getElementById('items-area').appendChild(div);
        }

        function saveOrder() {
            const tel = document.getElementById('cust-tel').value;
            const rows = document.querySelectorAll('.item-box');
            if(!tel || rows.length === 0) return alert("é›»è©±åŠå•†å“ç‚ºå¿…å¡«");

            let items = [], total = 0, notifyTxt = "";
            rows.forEach(r => {
                const n = r.querySelector('.in-n').value;
                const q = parseInt(r.querySelector('.in-q').value);
                const p = parseFloat(r.querySelector('.in-p').value) || 0;
                const c = parseFloat(r.querySelector('.in-c').value) || 0;
                if(n) {
                    items.push({name:n, qty:q, price:p, cost:c, bought:false, arrived:false});
                    total += (q * p);
                    notifyTxt += `- ${n} x ${q}\n`;
                }
            });

            const id = `WS${new Date().getFullYear().toString().slice(-2)}${serial++}`;
            const newOrder = { id, date: document.getElementById('order-date').value, tel, items, totalPrice: total, paid:false, shipped:false, refunded:false, address: "", sfNo: "" };
            
            orders.push(newOrder);
            localStorage.setItem('slow_v61_data', JSON.stringify(orders));
            localStorage.setItem('slow_v61_serial', serial);

            // WhatsApp é€šçŸ¥
            const msg = `ã€SlowOver å‡ºå–®é€šçŸ¥ã€‘\nå–®è™Ÿï¼š#${id}\né›»è©±ï¼š${tel}\né …ç›®ï¼š\n${notifyTxt}\nç¸½æ•¸ï¼š$${total}\nè«‹ç¢ºèªè³‡æ–™ï¼Œè¬è¬ï¼`;
            window.open(`https://wa.me/852${tel}?text=${encodeURIComponent(msg)}`);
            
            location.reload();
        }

        function render() {
            const list = document.getElementById('list-container');
            if(!list) return;
            list.innerHTML = orders.slice().reverse().map((o, idx) => {
                const realIdx = orders.indexOf(o);
                return `
                <div class="order-card">
                    <div style="display:flex; justify-content:space-between;">
                        <small>#${o.id} | ${o.date}</small>
                        <b style="color:var(--red)">$${o.totalPrice}</b>
                    </div>
                    <strong>ğŸ“ ${o.tel}</strong>
                    ${o.items.map((it, ii) => `
                        <div class="item-box" style="font-size:13px;">
                            ${it.name} x${it.qty}
                            <span class="tag-btn ${it.bought?'tag-bought':''}" onclick="toggleItem(${realIdx},${ii},'bought')">${it.bought?'å·²è²·':'æœªè²·'}</span>
                            <span class="tag-btn ${it.arrived?'tag-arrived':''}" onclick="toggleItem(${realIdx},${ii},'arrived')">${it.arrived?'å·²åˆ°æ¸¯':'æœªåˆ°'}</span>
                        </div>
                    `).join('')}
                    
                    <div class="status-grid">
                        <div class="st-btn paid ${o.paid?'active':''}" onclick="upd(${realIdx},'paid')">å·²ä»˜</div>
                        <div class="st-btn shipped ${o.shipped?'active':''}" onclick="upd(${realIdx},'shipped')">å·²å¯„</div>
                        <div class="st-btn refunded ${o.refunded?'active':''}" onclick="upd(${realIdx},'refunded')">å·²é€€æ¬¾</div>
                    </div>

                    <div style="display:flex; gap:5px;">
                        <button style="font-size:11px; background:#E9ECEF; color:#333;" onclick="setInfo(${realIdx},'address','æ”¶è²¨è³‡æ–™')">ğŸ  è³‡æ–™</button>
                        <button style="font-size:11px; background:#E9ECEF; color:#333;" onclick="setInfo(${realIdx},'sfNo','é †è±å–®è™Ÿ')">ğŸ“¦ å–®è™Ÿ</button>
                    </div>
                    ${o.address || o.sfNo ? `<div class="info-tag">${o.address?`ğŸ“ ${o.address}<br>`:''}${o.sfNo?`ğŸšš SF: ${o.sfNo}`:''}</div>`:''}
                </div>`;
            }).join('');

            updateStats();
        }

        function toggleItem(i, ii, k) { orders[i].items[ii][k] = !orders[i].items[ii][k]; save(); }
        function upd(i, k) { orders[i][k] = !orders[i][k]; save(); }
        function setInfo(i, k, label) { const val = prompt(`è¼¸å…¥${label}:`, orders[i][k]); if(val!==null) { orders[i][k]=val; save(); } }
        function save() { localStorage.setItem('slow_v61_data', JSON.stringify(orders)); render(); }

        function updateStats() {
            let sales = 0, cost = 0, count = orders.length;
            orders.forEach(o => {
                if(!o.refunded) {
                    sales += o.totalPrice;
                    o.items.forEach(it => cost += (it.qty * it.cost));
                }
            });
            document.getElementById('stats-summary').innerHTML = `
                <div class="card" style="background:var(--primary); color:white;">
                    <p>ç¸½éŠ·å”®é¡: $${sales}</p>
                    <p>é ä¼°åˆ©æ½¤: $${sales - cost}</p>
                    <small>è¨‚å–®ç¸½æ•¸: ${count}</small>
                </div>
            `;
        }

        function calcEx() {
            const cur = document.getElementById('cur-sel').value;
            const amt = document.getElementById('ex-in').value;
            document.getElementById('ex-res').innerText = amt ? `â‰ˆ HKD $${(amt * rates[cur]).toFixed(2)}` : "";
        }

        function switchPage(p, btn) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            btn.classList.add('active');
            if(p === 'buy') renderBuy();
        }

        function renderBuy() {
            const container = document.getElementById('buy-container');
            let html = "";
            orders.forEach((o, i) => {
                o.items.forEach((it, ii) => {
                    if(!it.bought || !it.arrived) {
                        html += `<div class="card" style="font-size:13px;">
                            <b>#${o.id}</b> - ${it.name} x${it.qty} 
                            <button onclick="toggleItem(${i},${ii},'bought')" style="width:70px; float:right; font-size:10px; background:${it.bought?'#40C057':'#FFD43B'}">${it.bought?'å·²è²·':'å¾…è²·'}</button>
                        </div>`;
                    }
                });
            });
            container.innerHTML = html || "<p style='text-align:center; color:#999;'>ç›®å‰æ²’æœ‰å¾…æ¡è³¼é …ç›®</p>";
        }

        window.onload = () => { document.getElementById('order-date').valueAsDate = new Date(); addItemRow(); render(); };
    </script>
</body>
</html>
