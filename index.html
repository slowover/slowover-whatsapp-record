<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SlowOver CRM V82.0</title>
    <style>
        :root { 
            --primary: #D4A373; --bg: #FAF7F2; --text: #5F4B32; 
            --accent: #8EAD91; --blue: #5C7CFA; --red: #E03131; 
            --green: #40C057; --purple: #7048E8; --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: -apple-system, system-ui; background: var(--bg); color: var(--text); margin: 0; padding: 15px 15px calc(var(--safe-bottom) + 100px) 15px; }
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; padding-bottom: var(--safe-bottom); border-top: 1px solid #EEE; z-index: 1000; }
        .nav-item { flex: 1; padding: 15px 0; text-align: center; font-size: 11px; color: #999; font-weight: bold; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .card { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .page { display: none; max-width: 600px; margin: 0 auto; }
        .page.active { display: block; }
        input, select, button { width: 100%; padding: 12px; margin: 4px 0; border: 1px solid #E0D7CC; border-radius: 10px; font-size: 14px; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { opacity: 0.7; }
        button:disabled { background: #CCC !important; }
        .order-card { background: white; padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #EEE; border-left: 8px solid var(--primary); position: relative; }
        .item-box { background: #FCFAf7; padding: 12px; border-radius: 12px; margin: 8px 0; border: 1px solid #F0E6D8; position: relative; }
        .del-btn-small { position: absolute; top: 5px; right: 5px; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: #FFF5F5; border: 1px solid #FFC9C9; border-radius: 6px; color: var(--red); }
        .st-btn { font-size: 10px; padding: 10px 0; border-radius: 8px; background: #F8F9FA; color: #BBB; border: 1px solid #EEE; text-align: center; font-weight: bold; }
        .st-btn.active.paid { background: var(--green); color: white; border-color: var(--green); }
        .st-btn.active.ship { background: var(--blue); color: white; border-color: var(--blue); }
        .st-btn.active.ref { background: var(--red); color: white; border-color: var(--red); }
        .st-btn.arrAll.active { background: var(--purple); color: white; }
        .tag { font-size: 10px; padding: 6px 12px; border-radius: 6px; display: inline-block; cursor: pointer; margin-right: 5px; margin-top: 8px; font-weight: bold; border: 1px solid #DDD; background: #FFF; color: #999; }
        .tag.active.buy { background: #FFD43B; color: #856404; border-color: #FFD43B; }
        .tag.active.arr { background: var(--blue); color: white; border-color: var(--blue); }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('main', this)">ğŸ“ è¨‚å–®</div>
        <div class="nav-item" onclick="switchPage('buy', this)">ğŸ›ï¸ æ¡è³¼</div>
        <div class="nav-item" onclick="switchPage('stats', this)">ğŸ“Š çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchPage('tools', this)">âš™ï¸ è¨­å®š</div>
    </div>

    <div id="page-main" class="page active">
        <div class="card">
            <h3 style="margin:0 0 10px 0;">æ–°å»ºè¨‚å–®</h3>
            <input type="date" id="order-date">
            <input type="tel" id="cust-tel" placeholder="å®¢æˆ¶é›»è©± (WhatsApp)">
            <div id="new-items-container"></div>
            <button onclick="addNewItemField()" style="background:#F1F3F5; color:var(--text); margin-top:10px;">+ æ–°å¢å•†å“é …ç›®</button>
            <button id="save-btn" onclick="handleSaveAction()" style="height:55px; margin-top:15px; font-size:16px; background:var(--accent); font-weight:bold;">ğŸ’¾ å„²å­˜ä¸¦æº–å‚™åŒæ­¥</button>
        </div>
        <div id="list-container"></div>
    </div>

    <div id="page-buy" class="page">
        <div class="card" id="buy-content"></div>
    </div>

    <div id="page-stats" class="page">
        <div id="stats-summary" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;"></div>
        <div id="stats-list"></div>
    </div>

    <div id="page-tools" class="page">
        <div class="card">
            <h3>â˜ï¸ é›²ç«¯åŒæ­¥ä¸­å¿ƒ</h3>
            <p style="font-size: 12px; color: #666;">åŒæ­¥å¾Œ Google Sheets æœƒè‡ªå‹•æ‹†åˆ†æ¬„ä½ï¼Œæ–¹ä¾¿å ±è¡¨æŸ¥çœ‹ã€‚</p>
            <button onclick="syncToCloud()" style="background:var(--blue); height: 50px;">ğŸ“¤ ä¸Šå‚³ä¸¦æ›´æ–°å ±è¡¨</button>
            <button onclick="syncFromCloud()" style="background:var(--accent); margin-top:10px;">ğŸ“¥ å¾é›²ç«¯æ¢å¾©è³‡æ–™</button>
            <p id="sync-time" style="font-size:11px; color:#999; text-align:center; margin-top:12px;">æœ€å¾ŒåŒæ­¥æ™‚é–“ï¼šå°šæœªåŒæ­¥</p>
        </div>
        <div class="card">
            <h3>ğŸ’° åŒ¯ç‡åŠ©æ‰‹</h3>
            <select id="cur-sel" onchange="calcEx()">
                <option value="KRW">éŸ“å¹£ (0.00585)</option>
                <option value="JPY">æ—¥å¹£ (0.0525)</option>
                <option value="THB">æ³°å¹£ (0.222)</option>
            </select>
            <input type="number" id="ex-in" placeholder="å¤–å¹£é‡‘é¡" oninput="calcEx()">
            <div id="ex-res" style="font-size:28px; text-align:center; color:var(--primary); font-weight:bold; margin:10px 0;">$0.00</div>
        </div>
    </div>

    <script>
        // å·²è‡ªå‹•é…ç½®æ‚¨çš„ç¶²å€
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxPku0qTD-XQvctzBYfHQNflwBn0QH-WjwTzPwfWMDsyMvym94i0f-MlXtUbHpEjJZaRA/exec";

        let orders = JSON.parse(localStorage.getItem('slow_v82_data')) || [];
        let serial = parseInt(localStorage.getItem('slow_v82_serial')) || 300;
        let syncTime = localStorage.getItem('slow_sync_v82') || "å°šæœªåŒæ­¥";
        const MONTHS = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];

        window.onload = function() {
            document.getElementById('order-date').valueAsDate = new Date();
            document.getElementById('sync-time').innerText = "æœ€å¾ŒåŒæ­¥æ™‚é–“ï¼š" + syncTime;
            addNewItemField();
            render();
        };

        function addNewItemField() {
            const container = document.getElementById('new-items-container');
            const div = document.createElement('div');
            div.className = 'item-box new-item-row';
            div.innerHTML = `
                <input type="text" placeholder="å•†å“åç¨±" class="in-name" style="width:80%">
                <div style="display:flex; gap:5px;">
                    <input type="number" value="1" class="in-qty" style="flex:1">
                    <input type="number" placeholder="å”®åƒ¹" class="in-price" style="flex:2">
                </div>
                <div class="del-btn-small" onclick="this.parentElement.remove()">âœ•</div>
            `;
            container.appendChild(div);
        }

        function handleSaveAction() {
            const tel = document.getElementById('cust-tel').value.trim();
            const date = document.getElementById('order-date').value;
            const rows = document.querySelectorAll('.new-item-row');
            if (!tel || rows.length === 0) return alert("è«‹å¡«å¯«é›»è©±èˆ‡å•†å“");

            let newItems = [];
            let totalP = 0;
            rows.forEach(r => {
                const n = r.querySelector('.in-name').value;
                const q = parseInt(r.querySelector('.in-qty').value);
                const p = parseFloat(r.querySelector('.in-price').value);
                if (n) { newItems.push({name:n, qty:q, price:p, cost:0, bought:false, arrived:false}); totalP += (q*p); }
            });

            const id = `WS${new Date().getFullYear().toString().slice(-2)}${MONTHS[new Date().getMonth()]}${serial}`;
            orders.push({id, date, tel, items:newItems, totalPrice:totalP, totalCost:0, paid:false, shipped:false, refunded:false, address:"", sfNo:""});
            serial++;
            save(); render();
            document.getElementById('cust-tel').value = "";
            document.getElementById('new-items-container').innerHTML = "";
            addNewItemField();
        }

        async function syncToCloud() {
            const btn = event.target;
            btn.disabled = true; btn.innerText = "â˜ï¸ æ­£åœ¨æ›´æ–° Google å ±è¡¨...";
            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(orders)
                });
                syncTime = new Date().toLocaleString();
                localStorage.setItem('slow_sync_v82', syncTime);
                document.getElementById('sync-time').innerText = "æœ€å¾ŒåŒæ­¥æ™‚é–“ï¼š" + syncTime;
                alert("âœ… åŒæ­¥æˆåŠŸï¼\nGoogle Sheets å ±è¡¨å·²è‡ªå‹•åˆ†æ¬„æ›´æ–°ã€‚");
            } catch (e) { alert("âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); }
            finally { btn.disabled = false; btn.innerText = "ğŸ“¤ ä¸Šå‚³ä¸¦æ›´æ–°å ±è¡¨"; }
        }

        async function syncFromCloud() {
            if(!confirm("ç¢ºå®šè¦å¾é›²ç«¯æ¢å¾©å—ï¼Ÿç¾æœ‰è³‡æ–™å°‡è¢«è¦†è“‹ã€‚")) return;
            try {
                const r = await fetch(GAS_URL);
                const data = await r.json();
                if(data) { orders = data; save(); render(); alert("âœ… è³‡æ–™æ¢å¾©å®Œæˆï¼"); }
            } catch (e) { alert("âŒ ä¸‹è¼‰å¤±æ•—ï¼Œå¯èƒ½é›²ç«¯å°šç„¡å‚™ä»½"); }
        }

        function save() { 
            localStorage.setItem('slow_v82_data', JSON.stringify(orders)); 
            localStorage.setItem('slow_v82_serial', serial); 
        }

        function render() {
            const list = document.getElementById('list-container');
            if (orders.length === 0) { list.innerHTML = "<center style='color:#999; margin:20px;'>ç„¡è¨‚å–®</center>"; return; }
            list.innerHTML = orders.slice().reverse().map((o, i) => {
                const realIdx = orders.length - 1 - i;
                return `
                <div class="order-card">
                    <div style="display:flex; justify-content:space-between;"><small>#${o.id}</small><b>$${o.totalPrice}</b></div>
                    <strong>ğŸ“ ${o.tel}</strong>
                    ${o.items.map((it, ii) => `
                        <div class="item-box">
                            <div style="display:flex; justify-content:space-between;"><span>${it.name} x${it.qty}</span></div>
                            <div class="tag buy ${it.bought?'active':''}" onclick="toggleTag(${realIdx}, ${ii}, 'bought')">è²·</div>
                            <div class="tag arr ${it.arrived?'active':''}" onclick="toggleTag(${realIdx}, ${ii}, 'arrived')">åˆ°</div>
                        </div>
                    `).join('')}
                    <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:4px; margin-top:10px;">
                        <div class="st-btn paid ${o.paid?'active':''}" onclick="updStat(${realIdx},'paid')">ä»˜</div>
                        <div class="st-btn ship ${o.shipped?'active':''}" onclick="updStat(${realIdx},'shipped')">å¯„</div>
                        <div class="st-btn ref ${o.refunded?'active':''}" onclick="updStat(${realIdx},'refunded')">é€€</div>
                        <div class="st-btn" onclick="delOrder(${realIdx})" style="color:red">åˆª</div>
                    </div>
                </div>`;
            }).join('');
        }

        function toggleTag(oi, ii, k) { orders[oi].items[ii][k] = !orders[oi].items[ii][k]; save(); render(); }
        function updStat(oi, k) { orders[oi][k] = !orders[oi][k]; save(); render(); }
        function delOrder(idx) { if(confirm("åˆªé™¤ï¼Ÿ")) { orders.splice(idx,1); save(); render(); } }
        function switchPage(p, btn) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            btn.classList.add('active');
        }
        function calcEx() {
            const rates = { KRW: 0.00585, JPY: 0.0525, THB: 0.222 };
            const a = document.getElementById('ex-in').value;
            const c = document.getElementById('cur-sel').value;
            document.getElementById('ex-res').innerText = `$${(a * rates[c] * 1.03).toFixed(2)}`;
        }
    </script>
</body>
</html>
